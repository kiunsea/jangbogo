<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:title-pattern="$DECORATOR_TITLE - $CONTENT_TITLE">Welcome</title>
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .user-info-box {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .user-name {
            font-weight: 600;
            color: #495057;
        }
        .btn-logout-page {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-logout-page:hover {
            background: #c82333;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="page-header mt-3">
            <h1 class="mb-0 text-primary">장보고 관리화면</h1>
            <div class="user-info-box">
                <span class="user-name">
                    <i class="bi bi-person-circle"></i>
                    <span id="currentUserPage">사용자</span>
                </span>
                <button class="btn btn-logout-page btn-sm" onclick="handleLogoutFromPage()">
                    <i class="bi bi-box-arrow-right"></i> 로그아웃
                </button>
            </div>
        </div>
        
        <hr class="mb-3" style="border-top: 1px dotted gray;">
        
        <div id="card" class="card">
            <div class="card-body">
                <h5 id="card-title" class="card-title">쇼핑 데이터 수집(자동화)</h5>
                <p class="card-text">
                    온라인/오프라인 쇼핑몰에서 구매한 상품들을 자동으로 수집하여 저장합니다.<br/>
                    쇼핑몰 계정 정보는 암호화되어 현재 시스템에 저장됩니다.
                </p>
            </div>
            
            <hr class="mb-3" style="border-top: 1px dotted gray;">

            <div id="autosave_options_div" class="card-body">
                <h5 class="card-title mb-3">구매정보 저장 옵션</h5>
                <div class="mb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="bi bi-file-earmark-text"></i>&nbsp; <span>수집 결과 파일 저장</span>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="saveCollectionResultsNow()">지금저장</button>
                    </div>
                    <div class="ps-3 mb-2">
                        <ul class="list-group">
                            <li class="list-group-item">
                                <div class="d-flex align-items-center gap-2">
                                    <div style="white-space: nowrap;">저장 위치</div>
                                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                                        <input type="text" class="form-control form-control-sm flex-grow-1" 
                                               id="file_save_path" value="./exports" 
                                               placeholder="저장 경로를 입력하세요">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="setDefaultDocumentsPath()" title="기본 경로로 설정">
                                            <i class="bi bi-house-door"></i>
                                        </button>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>저장 포맷</div>
                                    <div>
                                        <select class="form-select form-select-sm" id="file_save_format" style="width: 150px;">
                                            <option value="json">JSON</option>
                                            <option value="csv">CSV</option>
                                            <option value="excel">Excel</option>
                                        </select>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>구매내역 수집시 함께 저장</div>
                                    <div>
                                        <input type="checkbox" class="form-check-input" id="auto_save_on_collect" value="1">
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <hr class="mb-3" style="border-top: 1px dotted gray;">

            <div id="automall_div" class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">쇼핑몰 목록</h5>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="autoCollectSelected()">자동수집</button>
                </div>
                <div id="mall_list">
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shop"></i>&nbsp; <span>SSG(신세계)</span>
                        </div>
                        <div class="ps-3 mb-2">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    URL : <a class="icon-link icon-link-hover" href="https://www.ssg.com" target="_blank">
                                        https://www.ssg.com
                                    </a>
                                </li>
                                <li class="list-group-item">신세계, 이마트, 트레이더스, 노브랜드</li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>자동 수집 주기(분)</div>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="number" class="form-control form-control-sm mall-interval" 
                                                   data-seq="1" value="0" min="0" placeholder="주기(분)" 
                                                   style="width: 100px;" title="자동수집 주기(분)">
                                            <input type="checkbox" class="form-check-input mall-check" value="1">
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <button id="btn_signin_ssg" type="button"
                                        class="btn btn-primary btn-sm btn-block"
                                        onclick="javascript:openSigninMallForm(1)">계정연결</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shop"></i>&nbsp; <span>OASIS(오아시스)</span>
                        </div>
                        <div class="ps-3 mb-2">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    URL : <a class="icon-link icon-link-hover"
                                        href="https://www.oasis.co.kr" target="_blank">
                                        https://www.oasis.co.kr
                                    </a>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>자동 수집 주기(분)</div>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="number" class="form-control form-control-sm mall-interval" 
                                                   data-seq="2" value="0" min="0" placeholder="주기(분)" 
                                                   style="width: 100px;" title="자동수집 주기(분)">
                                            <input type="checkbox" class="form-check-input mall-check" value="2">
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <button id="btn_signin_oasis" type="button"
                                        class="btn btn-primary btn-sm btn-block"
                                        onclick="javascript:openSigninMallForm(2)">계정연결</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- 쇼핑몰 로그인 팝업 시작 -->
                <div id="ModalSigninMall" class="modal fade" tabindex="-1"
                    role="dialog" aria-labelledby="signinMallModal" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 id="signinMallModal_title" class="modal-title">Modal title</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="input-group mb-2">
                                    <input id="usrid_mall" type="text" class="form-control" placeholder="아이디" value="">
                                    &nbsp;
                                    <input id="usrpass_mall" type="password" class="form-control" placeholder="비밀번호">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button id="btn_connect_mall" type="button" class="btn btn-primary">계정연결</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 쇼핑몰 로그인 팝업 끝 -->
                
                <script type="text/javascript">
                
                /**
                 * 쇼핑몰 정보 초기화
                 */
                document.addEventListener('DOMContentLoaded', function() { //dom 이 준비되면 실행
                    const _doc = window.document;
                    var path = "/malls/getinfo";
                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText;
                            if (resMsg.length > 0) {
                                let resJson = JSON.parse(resMsg);
                                var alertMsg = null;
                                if (resJson.code == 200) {
                                    // 기본 저장 경로 설정 (Windows 내문서)
                                    if (resJson.defaultExportPath) {
                                        _doc.defaultExportPath = resJson.defaultExportPath; // 전역 변수에 저장
                                    }
                                    
                                    // 파일 저장 설정 적용
                                    if (resJson.exportConfig) {
                                        const exportConfig = resJson.exportConfig;
                                        const pathInput = _doc.querySelector('#file_save_path');
                                        const formatSelect = _doc.querySelector('#file_save_format');
                                        const autoSaveCheck = _doc.querySelector('#auto_save_on_collect');
                                        
                                        if (exportConfig.save_path && exportConfig.save_path !== '') {
                                            pathInput.value = exportConfig.save_path;
                                        } else if (resJson.defaultExportPath) {
                                            pathInput.value = resJson.defaultExportPath;
                                        }
                                        
                                        if (exportConfig.save_format) {
                                            formatSelect.value = exportConfig.save_format;
                                        }
                                        
                                        if (exportConfig.auto_save_enabled != null) {
                                            autoSaveCheck.checked = (exportConfig.auto_save_enabled == 1);
                                        }
                                    } else if (resJson.defaultExportPath) {
                                        _doc.querySelector('#file_save_path').value = resJson.defaultExportPath;
                                    }
                                        
                                    if (resJson.malls) {
                                        let malls = _doc.malls = resJson.malls;
                                        malls.forEach(mall => {
                                            if (_doc.querySelector("#btn_signin_"+mall.id)) { //사용 가능 쇼핑몰
                                                if (mall.account_status == 1) {
                                                    if (mall.usrid) {
                                                        _doc.querySelector("#usrid_mall").value = mall.usrid;
                                                        _doc.querySelector("#usrpass_mall").value = "**********";
                                                    }
                                                    _doc.querySelector("#usrid_mall").disabled = true;;
                                                    _doc.querySelector("#usrpass_mall").disabled = true;                                        
                                                    _doc.querySelector("#btn_signin_"+mall.id).textContent = '연결해제';
                                                    _doc.querySelector("#btn_signin_"+mall.id).className = 'btn btn-outline-success';
                                                    _doc.querySelector("#btn_signin_"+mall.id).setAttribute('onclick', 'javascript:connectMall('+ mall.seq +')');
                                                    hideElement(_doc.querySelector("#mall_account_"+mall.id));
                                                    mall.account_status = 1;
                                                } else {
                                                    _doc.querySelector("#usrid_mall").disabled = false;;
                                                    _doc.querySelector("#usrpass_mall").disabled = false;;
                                                    _doc.querySelector("#btn_signin_"+mall.id).textContent = '계정연결';
                                                    _doc.querySelector("#btn_signin_"+mall.id).className = 'btn btn-primary';
                                                    _doc.querySelector("#btn_signin_"+mall.id).setAttribute('onclick', 'javascript:openSigninMallForm('+ mall.seq +')');
                                                    showElement(_doc.querySelector("#mall_account_"+mall.id));
                                                    mall.account_status = 0;
                                                }
                                                // 체크박스 상태 반영 (auto_collect)
                                                const cb = _doc.querySelector('input.mall-check[value="'+ mall.seq +'"]');
                                                if (cb) { cb.checked = (mall.auto_collect == 1); }
                                                
                                                // 주기 설정 값 반영 (collect_interval_minutes)
                                                const intervalInput = _doc.querySelector('input.mall-interval[data-seq="'+ mall.seq +'"]');
                                                if (intervalInput && mall.collect_interval_minutes != null) {
                                                    intervalInput.value = mall.collect_interval_minutes;
                                                }
                                            }
                                        });
                                    }
                                    if (resJson.boxes) {
                                        _doc.boxes = resJson.boxes;
                                    }
                                    if (resJson.rules) {
                                        const div_rules = _doc.querySelector("#rules");

                                        let rules = _doc.rules = resJson.rules;
                                        Object.keys(rules).forEach(key => {
                                            const rule = rules[key];
                                            createRuleCard(div_rules, rule);
                                        });
                                    }
                                }
                            }
                        }
                    };
                    sendGet(_ajax, path);
                });

                // 배열에서 seq로 mall 객체 찾기
                function findMallBySeq(seqm) {
                    const malls = (window.document.malls || []);
                    return malls.find(m => String(m.seq) === String(seqm));
                }

                /**
                 * 쇼핑몰 연결 팝업
                 */
                function openSigninMallForm(seqm) {
                    const _doc = window.document;
                    const mall = findMallBySeq(seqm);

                    if (mall && (mall.account_status === 1 || mall.status === 1)) {
                        connectMall(seqm);
                    } else {
                        let inp_id = _doc.querySelector("#usrid_mall");
                        let inp_pw = _doc.querySelector("#usrpass_mall");
                        
                        //초기화
                        inp_id.value = "";
                        inp_pw.value = "";
                        inp_id.disabled = false;
                        inp_pw.disabled = false;

                        if (seqm == 1) {
                            _doc.querySelector('#signinMallModal_title').innerText = "SSG 계정연결";
                        } else if (seqm == 2) {
                            _doc.querySelector('#signinMallModal_title').innerText = "오아시스 계정연결";
                        }
                        _doc.querySelector('#btn_connect_mall').setAttribute('onclick', 'javascript:connectMall('+ seqm +')');
                        var myModal = bootstrap.Modal.getOrCreateInstance(_doc.querySelector('#ModalSigninMall'));
                        myModal.show();
                    }
                }

                /**
                 * 쇼핑몰에 연결 시도
                 */
                function connectMall(seqm) {
                    const _doc = window.document;
                    const mall = findMallBySeq(seqm);

                    var statusTo = -1;
                    if (mall && (mall.account_status === 1 || mall.status === 1)) {
                        if (!confirm("연결을 해제할까요?")) {
                            return -1;
                        }
                        statusTo = 0;
                    } else {
                        statusTo = 1;
                    }

                    let inp_id = _doc.querySelector("#usrid_mall");
                    let inp_pw = _doc.querySelector("#usrpass_mall");
                    let frm_conn = mall ? _doc.querySelector("#mall_account_"+ mall.id) : null;
                    let btn_conn = _doc.querySelector("#btn_connect_mall");
                    let btn_signin = mall ? _doc.querySelector("#btn_signin_"+ mall.id) : null;
                    
                    attachSpinnerButton(btn_conn);

                    var path = "/mall/connect";
                    var params = "seq="+seqm;
                    params += "&usrid="+inp_id.value;
                    params += "&usrpass="+inp_pw.value;
                    params += "&statusTo="+statusTo; //요청하려는 연결 상태
                    
                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText;
                            if (resMsg.length > 0) {
                                var resJson = JSON.parse(resMsg);
                                var alertMsg = null;
                                var btn_txt = "계정연결";
                                var btn_class = "btn btn-primary";
                                if (resJson.code == "000") {
                                    var status = resJson.status;
                                    if (mall) { mall.account_status = status; mall.status = status; }
                                    if (status == 1) {
                                        inp_id.disabled = true;
                                        inp_pw.disabled = true;
                                        btn_txt = '연결해제';
                                        btn_class = 'btn btn-outline-success';
                                        hideElement(frm_conn);
                                        if (btn_signin) { btn_signin.setAttribute('onclick', 'javascript:connectMall('+ seqm +')'); }
                                    } else {
                                        inp_id.disabled = false;
                                        inp_pw.disabled = false;
                                        btn_txt = '계정연결';
                                        showElement(frm_conn);
                                        if (btn_signin) { btn_signin.setAttribute('onclick', 'javascript:openSigninMallForm('+ seqm +')'); }
                                    }                                                            
                                }
                                
                                if (resJson.msg) {
                                    alert(resJson.msg);
                                }

                                removeSpinnerButton(btn_conn, "계정연결");
                                if (btn_signin) { btn_signin.innerText = btn_txt; btn_signin.className = btn_class; }

                                var myModal = bootstrap.Modal.getOrCreateInstance(_doc.querySelector('#ModalSigninMall'));
                                myModal.hide();
                            }
                        }
                    };
                    sendPost(_ajax, path, params);
                }

                // 선택된 쇼핑몰 자동수집 즉시 실행 또는 취소
                function autoCollectSelected() {
                    const _doc = window.document;
                    const checked = Array.from(_doc.querySelectorAll('input.mall-check:checked'))
                        .map(el => String(el.value));
                    if (!checked.length) {
                        alert('선택된 쇼핑몰이 없습니다.');
                        return;
                    }
                    
                    // 즉시 실행 여부 확인
                    const executeNow = confirm('지금 즉시 최근 구매목록을 수집할까요?\n\n확인: 즉시 수집 시작\n취소: 주기적 수집만 활성화');

                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText || '';
                            try {
                                var resJson = JSON.parse(resMsg);
                                if (resJson) {
                                    // 오류 처리
                                    var errs = [];
                                    if (Array.isArray(resJson.decryptionFailed) && resJson.decryptionFailed.length) {
                                        errs = errs.concat(resJson.decryptionFailed.map(String));
                                    }
                                    if (Array.isArray(resJson.skipped) && resJson.skipped.length) {
                                        errs = errs.concat(resJson.skipped.map(String));
                                    }

                                    if (errs.length) {
                                        // 오류난 쇼핑몰들을 UI에서 해제 상태로 전환
                                        errs.forEach(function(seq){
                                            try {
                                                var mall = findMallBySeq(seq);
                                                if (!mall) return;
                                                mall.account_status = 0; mall.status = 0;
                                                var btn = document.querySelector('#btn_signin_' + mall.id);
                                                if (btn) {
                                                    btn.innerText = '계정연결';
                                                    btn.className = 'btn btn-primary btn-sm btn-block';
                                                    btn.setAttribute('onclick', 'javascript:openSigninMallForm(' + seq + ')');
                                                }
                                            } catch(e) { /* ignore per item */ }
                                        });
                                    }
                                    
                                    // 메시지 표시 (자동수집 완료 메시지만)
                                    let msg = resJson.message || '';
                                    if (msg) {
                                        alert(msg);
                                    }
                                    
                                    // 파일 자동저장 결과는 서버 로그로만 기록 (alert 안 함)
                                    if (resJson.autoSaved && resJson.exportedFile) {
                                        console.log('파일 자동저장 완료:', resJson.exportedFile);
                                    } else if (resJson.autoSaveSkipped) {
                                        console.log('파일 저장 건너뜀:', resJson.autoSaveReason);
                                    } else if (resJson.autoSaveError) {
                                        console.warn('파일 자동저장 실패:', resJson.autoSaveError);
                                    }
                                }
                            } catch (e) {
                                // ignore
                            }
                        }
                    };
                    _ajax.open('POST', '/malls/auto-collect', true);
                    _ajax.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    // 실행 전에 체크박스 상태 저장
                    saveAutoCollectFlagsFromUI(function() {
                        _ajax.send(JSON.stringify({ seqs: checked, executeNow: executeNow }));
                    });
                }

                // 체크박스 전체 상태 및 주기 저장 (체크된 seq만 전달, 나머지는 0 처리)
                function saveAutoCollectFlagsFromUI(done) {
                    const _doc = window.document;
                    const checked = Array.from(_doc.querySelectorAll('input.mall-check:checked'))
                        .map(el => String(el.value));
                    
                    // 모든 쇼핑몰의 주기 값 수집
                    const intervals = {};
                    _doc.querySelectorAll('input.mall-interval').forEach(input => {
                        const seq = input.getAttribute('data-seq');
                        const value = parseInt(input.value) || 0;
                        if (seq) {
                            intervals[seq] = value;
                        }
                    });
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            if (typeof done === 'function') done();
                        }
                    };
                    xhr.open('POST', '/malls/auto-collect/flags', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ seqs: checked, intervals: intervals }));
                }

                // 체크박스 또는 주기 입력 필드 변경 시 즉시 저장
                document.addEventListener('change', function(e) {
                    if (e.target && (e.target.matches('input.mall-check') || e.target.matches('input.mall-interval'))) {
                        saveAutoCollectFlagsFromUI();
                    }
                    
                    // 파일 저장 설정 변경 시 저장
                    if (e.target && (e.target.id === 'auto_save_on_collect' || 
                                     e.target.id === 'file_save_format')) {
                        saveExportConfigToServer();
                    }
                });
                
                // 저장 경로 입력 필드는 blur 시 저장
                document.querySelector('#file_save_path').addEventListener('blur', function() {
                    saveExportConfigToServer();
                });
                
                /**
                 * 파일 저장 설정을 서버에 저장
                 */
                function saveExportConfigToServer() {
                    const _doc = window.document;
                    const savePath = _doc.querySelector('#file_save_path').value;
                    const saveFormat = _doc.querySelector('#file_save_format').value;
                    const autoSaveEnabled = _doc.querySelector('#auto_save_on_collect').checked;
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    console.log('파일 저장 설정 저장 완료');
                                }
                            } catch (e) {
                                console.error('설정 저장 응답 파싱 오류:', e);
                            }
                        }
                    };
                    
                    xhr.open('POST', '/export/config', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: savePath, 
                        format: saveFormat,
                        autoSaveEnabled: autoSaveEnabled
                    }));
                }
                
                /**
                 * 기본 경로(내문서)로 설정
                 */
                function setDefaultDocumentsPath() {
                    const pathInput = document.querySelector('#file_save_path');
                    const defaultPath = window.document.defaultExportPath;
                    
                    if (defaultPath) {
                        pathInput.value = defaultPath;
                        saveExportConfigToServer(); // 변경 시 저장
                        console.log('기본 경로로 설정됨:', defaultPath);
                    } else {
                        alert('기본 경로를 불러올 수 없습니다.\n경로를 직접 입력해주세요.\n\n예시: C:\\Users\\사용자명\\Documents\\jangbogo_exports');
                    }
                }
                
                /**
                 * 수집 결과를 파일로 지금 저장
                 */
                function saveCollectionResultsNow() {
                    const _doc = window.document;
                    const savePath = _doc.querySelector('#file_save_path').value;
                    const saveFormat = _doc.querySelector('#file_save_format').value;
                    
                    if (!savePath || savePath.trim() === '') {
                        alert('저장 위치를 입력해주세요.');
                        return;
                    }
                    
                    if (!confirm('구매정보를 파일로 저장하시겠습니까?\n\n저장 위치: ' + savePath + '\n저장 포맷: ' + saveFormat.toUpperCase())) {
                        return;
                    }
                    
                    // 서버에 파일 저장 요청
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    alert('파일 저장이 완료되었습니다.\n\n저장 위치: ' + (resJson.filePath || savePath));
                                } else {
                                    alert('파일 저장 실패: ' + (resJson.message || '알 수 없는 오류'));
                                }
                            } catch (e) {
                                alert('파일 저장 응답 처리 중 오류가 발생했습니다.');
                                console.error('응답 파싱 오류:', e);
                            }
                        }
                    };
                    
                    xhr.open('POST', '/export/orders', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: savePath, 
                        format: saveFormat 
                    }));
                }
                </script>
            </div>
            
        </div>
        
    </div>
</body>
</html>
