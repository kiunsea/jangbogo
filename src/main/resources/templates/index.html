<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:title-pattern="$DECORATOR_TITLE - $CONTENT_TITLE">Welcome</title>
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .user-info-box {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .user-name {
            font-weight: 600;
            color: #495057;
        }
        .btn-logout-page {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-logout-page:hover {
            background: #c82333;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="page-header mt-3">
            <h1 class="mb-0 text-primary">장보고 관리화면</h1>
            <div class="user-info-box">
                <span class="user-name">
                    <i class="bi bi-person-circle"></i>
                    <span id="currentUserPage">사용자</span>
                </span>
                <button class="btn btn-logout-page btn-sm" onclick="handleLogoutFromPage()">
                    <i class="bi bi-box-arrow-right"></i> 로그아웃
                </button>
            </div>
        </div>
        
        <hr class="mb-3" style="border-top: 1px dotted gray;">
        
        <div id="card" class="card">
            <div class="card-body">
                <h5 id="card-title" class="card-title">쇼핑 데이터 수집(자동화)</h5>
                <p class="card-text">
                    온라인/오프라인 쇼핑몰에서 구매한 상품들을 자동으로 수집하여 저장합니다.<br/>
                    쇼핑몰 계정 정보는 암호화되어 현재 시스템에 저장됩니다.
                </p>
            </div>
            
            <hr class="mb-3" style="border-top: 1px dotted gray;">
            
            <div id="automall_div" class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">쇼핑몰 목록</h5>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="autoCollectSelected()">자동수집</button>
                </div>
                <div id="mall_list">
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shop"></i>&nbsp; <span>SSG(신세계)</span>
                        </div>
                        <div class="ps-3 mb-2">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    URL : <a class="icon-link icon-link-hover" href="https://www.ssg.com" target="_blank">
                                        https://www.ssg.com
                                    </a>
                                </li>
                                <li class="list-group-item">신세계, 이마트, 트레이더스, 노브랜드</li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>자동 수집 주기(분)</div>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="number" class="form-control form-control-sm mall-interval" 
                                                   data-seq="1" value="0" min="0" placeholder="주기(분)" 
                                                   style="width: 100px;" title="자동수집 주기(분)">
                                            <input type="checkbox" class="form-check-input mall-check" value="1">
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <button id="btn_signin_ssg" type="button"
                                        class="btn btn-primary btn-sm btn-block"
                                        onclick="javascript:openSigninMallForm(1)">계정연결</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shop"></i>&nbsp; <span>OASIS(오아시스)</span>
                        </div>
                        <div class="ps-3 mb-2">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    URL : <a class="icon-link icon-link-hover"
                                        href="https://www.oasis.co.kr" target="_blank">
                                        https://www.oasis.co.kr
                                    </a>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>자동 수집 주기(분)</div>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="number" class="form-control form-control-sm mall-interval" 
                                                   data-seq="2" value="0" min="0" placeholder="주기(분)" 
                                                   style="width: 100px;" title="자동수집 주기(분)">
                                            <input type="checkbox" class="form-check-input mall-check" value="2">
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <button id="btn_signin_oasis" type="button"
                                        class="btn btn-primary btn-sm btn-block"
                                        onclick="javascript:openSigninMallForm(2)">계정연결</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- 쇼핑몰 로그인 팝업 시작 -->
                <div id="ModalSigninMall" class="modal fade" tabindex="-1"
                    role="dialog" aria-labelledby="signinMallModal" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 id="signinMallModal_title" class="modal-title">Modal title</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="input-group mb-2">
                                    <input id="usrid_mall" type="text" class="form-control" placeholder="아이디" value="">
                                    &nbsp;
                                    <input id="usrpass_mall" type="password" class="form-control" placeholder="비밀번호">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button id="btn_connect_mall" type="button" class="btn btn-primary">계정연결</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 쇼핑몰 로그인 팝업 끝 -->
                
                <script type="text/javascript">
                
                // FTP 비밀번호 존재 여부 플래그
                var hasFtpPassword = false;
                
                /**
                 * 쇼핑몰 정보 초기화
                 */
                document.addEventListener('DOMContentLoaded', function() { //dom 이 준비되면 실행
                    const _doc = window.document;
                    var path = "/malls/getinfo";
                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText;
                            if (resMsg.length > 0) {
                                let resJson = JSON.parse(resMsg);
                                var alertMsg = null;
                                if (resJson.code == 200) {
                                    // 기본 저장 경로 설정 (Windows 내문서)
                                    if (resJson.defaultExportPath) {
                                        _doc.defaultExportPath = resJson.defaultExportPath; // 전역 변수에 저장
                                    }
                                    
                                    // 파일 저장 설정 적용
                                    if (resJson.exportConfig) {
                                        const exportConfig = resJson.exportConfig;
                                        const pathInput = _doc.querySelector('#file_save_path');
                                        const formatSelect = _doc.querySelector('#file_save_format');
                                        const autoSaveCheck = _doc.querySelector('#auto_save_on_collect');
                                        const saveToFTPCheck = _doc.querySelector('#save_to_ftp');
                                        const ftpEncryptCheck = _doc.querySelector('#ftp_encrypt_enabled');
                                        const ftpAddressInput = _doc.querySelector('#ftp_address');
                                        const ftpIdInput = _doc.querySelector('#ftp_id');
                                        const ftpPassInput = _doc.querySelector('#ftp_pass');
                                        
                                        if (exportConfig.save_path && exportConfig.save_path !== '') {
                                            pathInput.value = exportConfig.save_path;
                                        } else if (resJson.defaultExportPath) {
                                            pathInput.value = resJson.defaultExportPath;
                                        }
                                        
                                        if (exportConfig.save_format) {
                                            formatSelect.value = exportConfig.save_format;
                                        }
                                        
                                        if (exportConfig.auto_save_enabled != null) {
                                            autoSaveCheck.checked = (exportConfig.auto_save_enabled == 1);
                                        }
                                        
                                        // FTP 저장 설정 적용 (DB 컬럼: save_to_jiniebox)
                                        const saveToJinieboxValue = 
                                            (exportConfig.save_to_jiniebox !== undefined) ? exportConfig.save_to_jiniebox
                                            : exportConfig.save_to_ftp;
                                        if (saveToJinieboxValue != null) {
                                            saveToFTPCheck.checked = (parseInt(saveToJinieboxValue, 10) === 1);
                                        }
                                        
                                        // FTP 암호화 설정 적용
                                        if (ftpEncryptCheck) {
                                            let ftpEncryptValue = 1;
                                            if (exportConfig.ftp_encrypt_enabled !== undefined && exportConfig.ftp_encrypt_enabled !== null) {
                                                ftpEncryptValue = parseInt(exportConfig.ftp_encrypt_enabled, 10);
                                                ftpEncryptValue = isNaN(ftpEncryptValue) ? 1 : ftpEncryptValue;
                                            }
                                            ftpEncryptCheck.checked = (ftpEncryptValue === 1);
                                        }
                                        
                                        // FTP 정보 적용
                                        if (exportConfig.ftp_address) {
                                            ftpAddressInput.value = exportConfig.ftp_address;
                                        }
                                        if (exportConfig.ftp_id) {
                                            ftpIdInput.value = exportConfig.ftp_id;
                                        }
                                        
                                        // FTP 비밀번호는 보안을 위해 평문을 표시하지 않음
                                        if (exportConfig.has_ftp_password) {
                                            hasFtpPassword = true;
                                            ftpPassInput.value = '';  // 비밀번호 필드는 비워둠
                                            ftpPassInput.placeholder = '기존 비밀번호 유지 (변경하려면 입력)';
                                        } else {
                                            hasFtpPassword = false;
                                            ftpPassInput.value = '';
                                            ftpPassInput.placeholder = 'FTP 비밀번호';
                                        }
                                        
                                        // Public Key 표시
                                        const publicKeyInput = _doc.querySelector('#public_key_input');
                                        if (exportConfig.public_key && exportConfig.public_key !== '') {
                                            publicKeyInput.value = exportConfig.public_key;
                                        }
                                        
                                        // FTP 설정 블록 초기 표시/숨김 (저장하지 않음)
                                        toggleFtpSettings(true);
                                        toggleFtpEncryption(true);
                                    } else if (resJson.defaultExportPath) {
                                        _doc.querySelector('#file_save_path').value = resJson.defaultExportPath;
                                    }
                                        
                                    if (resJson.malls) {
                                        let malls = _doc.malls = resJson.malls;
                                        malls.forEach(mall => {
                                            if (_doc.querySelector("#btn_signin_"+mall.id)) { //사용 가능 쇼핑몰
                                                if (mall.account_status == 1) {
                                                    if (mall.usrid) {
                                                        _doc.querySelector("#usrid_mall").value = mall.usrid;
                                                        _doc.querySelector("#usrpass_mall").value = "**********";
                                                    }
                                                    _doc.querySelector("#usrid_mall").disabled = true;;
                                                    _doc.querySelector("#usrpass_mall").disabled = true;                                        
                                                    _doc.querySelector("#btn_signin_"+mall.id).textContent = '연결해제';
                                                    _doc.querySelector("#btn_signin_"+mall.id).className = 'btn btn-outline-success';
                                                    _doc.querySelector("#btn_signin_"+mall.id).setAttribute('onclick', 'javascript:connectMall('+ mall.seq +')');
                                                    hideElement(_doc.querySelector("#mall_account_"+mall.id));
                                                    mall.account_status = 1;
                                                } else {
                                                    _doc.querySelector("#usrid_mall").disabled = false;;
                                                    _doc.querySelector("#usrpass_mall").disabled = false;;
                                                    _doc.querySelector("#btn_signin_"+mall.id).textContent = '계정연결';
                                                    _doc.querySelector("#btn_signin_"+mall.id).className = 'btn btn-primary';
                                                    _doc.querySelector("#btn_signin_"+mall.id).setAttribute('onclick', 'javascript:openSigninMallForm('+ mall.seq +')');
                                                    showElement(_doc.querySelector("#mall_account_"+mall.id));
                                                    mall.account_status = 0;
                                                }
                                                // 체크박스 상태 반영 (auto_collect)
                                                const cb = _doc.querySelector('input.mall-check[value="'+ mall.seq +'"]');
                                                if (cb) { cb.checked = (mall.auto_collect == 1); }
                                                
                                                // 주기 설정 값 반영 (collect_interval_minutes)
                                                const intervalInput = _doc.querySelector('input.mall-interval[data-seq="'+ mall.seq +'"]');
                                                if (intervalInput && mall.collect_interval_minutes != null) {
                                                    intervalInput.value = mall.collect_interval_minutes;
                                                }
                                            }
                                        });
                                    }
                                    if (resJson.boxes) {
                                        _doc.boxes = resJson.boxes;
                                    }
                                    if (resJson.rules) {
                                        const div_rules = _doc.querySelector("#rules");

                                        let rules = _doc.rules = resJson.rules;
                                        Object.keys(rules).forEach(key => {
                                            const rule = rules[key];
                                            createRuleCard(div_rules, rule);
                                        });
                                    }
                                }
                            }
                        }
                    };
                    sendGet(_ajax, path);
                });

                // 배열에서 seq로 mall 객체 찾기
                function findMallBySeq(seqm) {
                    const malls = (window.document.malls || []);
                    return malls.find(m => String(m.seq) === String(seqm));
                }

                /**
                 * 쇼핑몰 연결 팝업
                 */
                function openSigninMallForm(seqm) {
                    const _doc = window.document;
                    const mall = findMallBySeq(seqm);

                    if (mall && (mall.account_status === 1 || mall.status === 1)) {
                        connectMall(seqm);
                    } else {
                        let inp_id = _doc.querySelector("#usrid_mall");
                        let inp_pw = _doc.querySelector("#usrpass_mall");
                        
                        //초기화
                        inp_id.value = "";
                        inp_pw.value = "";
                        inp_id.disabled = false;
                        inp_pw.disabled = false;

                        if (seqm == 1) {
                            _doc.querySelector('#signinMallModal_title').innerText = "SSG 계정연결";
                        } else if (seqm == 2) {
                            _doc.querySelector('#signinMallModal_title').innerText = "오아시스 계정연결";
                        }
                        _doc.querySelector('#btn_connect_mall').setAttribute('onclick', 'javascript:connectMall('+ seqm +')');
                        var myModal = bootstrap.Modal.getOrCreateInstance(_doc.querySelector('#ModalSigninMall'));
                        myModal.show();
                    }
                }

                /**
                 * 쇼핑몰에 연결 시도
                 */
                function connectMall(seqm) {
                    const _doc = window.document;
                    const mall = findMallBySeq(seqm);

                    var statusTo = -1;
                    if (mall && (mall.account_status === 1 || mall.status === 1)) {
                        if (!confirm("연결을 해제할까요?")) {
                            return -1;
                        }
                        statusTo = 0;
                    } else {
                        statusTo = 1;
                    }

                    let inp_id = _doc.querySelector("#usrid_mall");
                    let inp_pw = _doc.querySelector("#usrpass_mall");
                    let frm_conn = mall ? _doc.querySelector("#mall_account_"+ mall.id) : null;
                    let btn_conn = _doc.querySelector("#btn_connect_mall");
                    let btn_signin = mall ? _doc.querySelector("#btn_signin_"+ mall.id) : null;
                    
                    attachSpinnerButton(btn_conn);

                    var path = "/mall/connect";
                    var params = "seq="+seqm;
                    params += "&usrid="+inp_id.value;
                    params += "&usrpass="+inp_pw.value;
                    params += "&statusTo="+statusTo; //요청하려는 연결 상태
                    
                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText;
                            if (resMsg.length > 0) {
                                var resJson = JSON.parse(resMsg);
                                var alertMsg = null;
                                var btn_txt = "계정연결";
                                var btn_class = "btn btn-primary";
                                if (resJson.code == "000") {
                                    var status = resJson.status;
                                    if (mall) { mall.account_status = status; mall.status = status; }
                                    if (status == 1) {
                                        inp_id.disabled = true;
                                        inp_pw.disabled = true;
                                        btn_txt = '연결해제';
                                        btn_class = 'btn btn-outline-success';
                                        hideElement(frm_conn);
                                        if (btn_signin) { btn_signin.setAttribute('onclick', 'javascript:connectMall('+ seqm +')'); }
                                    } else {
                                        inp_id.disabled = false;
                                        inp_pw.disabled = false;
                                        btn_txt = '계정연결';
                                        showElement(frm_conn);
                                        if (btn_signin) { btn_signin.setAttribute('onclick', 'javascript:openSigninMallForm('+ seqm +')'); }
                                    }                                                            
                                }
                                
                                if (resJson.msg) {
                                    alert(resJson.msg);
                                }

                                removeSpinnerButton(btn_conn, "계정연결");
                                if (btn_signin) { btn_signin.innerText = btn_txt; btn_signin.className = btn_class; }

                                var myModal = bootstrap.Modal.getOrCreateInstance(_doc.querySelector('#ModalSigninMall'));
                                myModal.hide();
                            }
                        }
                    };
                    sendPost(_ajax, path, params);
                }

                // 선택된 쇼핑몰 자동수집 즉시 실행 또는 취소
                function autoCollectSelected() {
                    const _doc = window.document;
                    const checked = Array.from(_doc.querySelectorAll('input.mall-check:checked'))
                        .map(el => String(el.value));
                    if (!checked.length) {
                        alert('선택된 쇼핑몰이 없습니다.');
                        return;
                    }
                    
                    // 즉시 실행 여부 확인
                    const executeNow = confirm('지금 즉시 최근 구매목록을 수집할까요?\n\n확인: 즉시 수집 시작\n취소: 주기적 수집만 활성화');

                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText || '';
                            try {
                                var resJson = JSON.parse(resMsg);
                                if (resJson) {
                                    // 오류 처리
                                    var errs = [];
                                    if (Array.isArray(resJson.decryptionFailed) && resJson.decryptionFailed.length) {
                                        errs = errs.concat(resJson.decryptionFailed.map(String));
                                    }
                                    if (Array.isArray(resJson.skipped) && resJson.skipped.length) {
                                        errs = errs.concat(resJson.skipped.map(String));
                                    }

                                    if (errs.length) {
                                        // 오류난 쇼핑몰들을 UI에서 해제 상태로 전환
                                        errs.forEach(function(seq){
                                            try {
                                                var mall = findMallBySeq(seq);
                                                if (!mall) return;
                                                mall.account_status = 0; mall.status = 0;
                                                var btn = document.querySelector('#btn_signin_' + mall.id);
                                                if (btn) {
                                                    btn.innerText = '계정연결';
                                                    btn.className = 'btn btn-primary btn-sm btn-block';
                                                    btn.setAttribute('onclick', 'javascript:openSigninMallForm(' + seq + ')');
                                                }
                                            } catch(e) { /* ignore per item */ }
                                        });
                                    }
                                    
                                    // 메시지 표시 (자동수집 완료 메시지만)
                                    let msg = resJson.message || '';
                                    if (msg) {
                                        alert(msg);
                                    }
                                    
                                    // 파일 자동저장 결과는 서버 로그로만 기록 (alert 안 함)
                                    if (resJson.autoSaved && resJson.exportedFile) {
                                        console.log('파일 자동저장 완료:', resJson.exportedFile);
                                    } else if (resJson.autoSaveSkipped) {
                                        console.log('파일 저장 건너뜀:', resJson.autoSaveReason);
                                    } else if (resJson.autoSaveError) {
                                        console.warn('파일 자동저장 실패:', resJson.autoSaveError);
                                    }
                                }
                            } catch (e) {
                                // ignore
                            }
                        }
                    };
                    _ajax.open('POST', '/malls/auto-collect', true);
                    _ajax.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    // 실행 전에 체크박스 상태 저장
                    saveAutoCollectFlagsFromUI(function() {
                        _ajax.send(JSON.stringify({ seqs: checked, executeNow: executeNow }));
                    });
                }

                // 체크박스 전체 상태 및 주기 저장 (체크된 seq만 전달, 나머지는 0 처리)
                function saveAutoCollectFlagsFromUI(done) {
                    const _doc = window.document;
                    const checked = Array.from(_doc.querySelectorAll('input.mall-check:checked'))
                        .map(el => String(el.value));
                    
                    // 모든 쇼핑몰의 주기 값 수집
                    const intervals = {};
                    _doc.querySelectorAll('input.mall-interval').forEach(input => {
                        const seq = input.getAttribute('data-seq');
                        const value = parseInt(input.value) || 0;
                        if (seq) {
                            intervals[seq] = value;
                        }
                    });
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            if (typeof done === 'function') done();
                        }
                    };
                    xhr.open('POST', '/malls/auto-collect/flags', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ seqs: checked, intervals: intervals }));
                }

                // 체크박스 또는 주기 입력 필드 변경 시 즉시 저장
                document.addEventListener('change', function(e) {
                    if (e.target && (e.target.matches('input.mall-check') || e.target.matches('input.mall-interval'))) {
                        saveAutoCollectFlagsFromUI();
                    }
                    
                    // 파일 저장 설정 변경 시 저장
                    if (e.target && (e.target.id === 'auto_save_on_collect' || 
                                     e.target.id === 'file_save_format')) {
                        saveExportConfigToServer();
                    }
                });
                
                // 저장 경로 입력 필드는 blur 시 저장 (요소가 존재하는 페이지에서만)
                const fileSavePathInput = document.querySelector('#file_save_path');
                if (fileSavePathInput) {
                    fileSavePathInput.addEventListener('blur', function() {
                        saveExportConfigToServer();
                    });
                }
                
                /**
                 * 필수 필드 유효성 검사 공통 함수
                 * 
                 * @param {Array<string>} requiredFields - 필수 필드 목록
                 *   가능한 값: 'savePath', 'saveFormat', 'autoSaveEnabled', 'exportLimit', 
                 *             'saveToFTP', 'ftpAddress', 'ftpId', 'ftpPass', 'publicKey'
                 * @param {Object} options - 추가 옵션
                 *   - checksaveToFTP: true일 경우, saveToFTP가 체크되어 있으면 FTP 필드들도 필수로 체크
                 *   - ignoreFtpPassIfExists: true일 경우, 기존에 비밀번호가 있으면 ftpPass를 필수로 체크하지 않음
                 * @returns {Object} { valid: boolean, missingFields: Array<string>, values: Object }
                 */
                function validateRequiredFields(requiredFields, options = {}) {
                    const _doc = window.document;
                    const missingFields = [];
                    const fieldLabels = {
                        savePath: '저장 위치',
                        saveFormat: '저장 포맷',
                        autoSaveEnabled: '구매내역 수집시 함께 저장',
                        exportLimit: '저장 범위',
                        saveToFTP: 'FTP에도 함께 저장',
                        ftpEncryptEnabled: 'FTP 암호화 사용',
                        ftpAddress: 'FTP 주소',
                        ftpId: 'FTP 아이디',
                        ftpPass: 'FTP 비밀번호',
                        publicKey: 'Public Key'
                    };
                    
                    // 모든 필드 값 수집
                    const values = {
                        savePath: _doc.querySelector('#file_save_path')?.value || '',
                        saveFormat: _doc.querySelector('#file_save_format')?.value || '',
                        autoSaveEnabled: _doc.querySelector('#auto_save_on_collect')?.checked || false,
                        exportLimit: parseInt(_doc.querySelector('#export_limit')?.value) || 0,
                        saveToFTP: _doc.querySelector('#save_to_ftp')?.checked || false,
                        ftpEncryptEnabled: (_doc.querySelector('#ftp_encrypt_enabled')?.checked !== false),
                        ftpAddress: _doc.querySelector('#ftp_address')?.value || '',
                        ftpId: _doc.querySelector('#ftp_id')?.value || '',
                        ftpPass: _doc.querySelector('#ftp_pass')?.value || '',
                        publicKey: _doc.querySelector('#public_key_input')?.value || ''
                    };
                    
                    // saveToFTP가 체크되어 있으면 FTP 관련 필드들도 필수로 추가
                    let effectiveRequiredFields = [...requiredFields];
                    if (options.checksaveToFTP && values.saveToFTP) {
                        const ftpFields = ['ftpAddress', 'ftpId', 'ftpPass'];
                        if (values.ftpEncryptEnabled) {
                            ftpFields.push('publicKey');
                        }
                        ftpFields.forEach(field => {
                            if (!effectiveRequiredFields.includes(field)) {
                                effectiveRequiredFields.push(field);
                            }
                        });
                    }
                    
                    // 필수 필드 검증
                    effectiveRequiredFields.forEach(field => {
                        if (field === 'autoSaveEnabled' || field === 'saveToFTP' || field === 'ftpEncryptEnabled') {
                            // 체크박스는 체크 여부만 확인 (항상 값이 있음)
                            return;
                        }
                        
                        if (field === 'ftpPass') {
                            // FTP 비밀번호: ignoreFtpPassIfExists 옵션이 있고 기존 비밀번호가 있으면 스킵
                            if (options.ignoreFtpPassIfExists && hasFtpPassword && !values.ftpPass.trim()) {
                                return; // 기존 비밀번호 유지
                            }
                            // 새로운 비밀번호 입력 필수
                            if (!values.ftpPass.trim()) {
                                missingFields.push(fieldLabels[field]);
                            }
                        } else if (field === 'exportLimit') {
                            // exportLimit는 숫자이므로 0이어도 유효
                            // 필드가 없거나 음수인 경우만 오류
                            if (values.exportLimit === null || values.exportLimit === undefined || values.exportLimit < 0) {
                                missingFields.push(fieldLabels[field]);
                            }
                        } else {
                            // 일반 텍스트 필드: 비어있으면 오류
                            if (!values[field] || values[field].trim() === '') {
                                missingFields.push(fieldLabels[field]);
                            }
                        }
                    });
                    
                    return {
                        valid: missingFields.length === 0,
                        missingFields: missingFields,
                        values: values
                    };
                }
                
                /**
                 * Public Key만 저장 (전용 함수)
                 * 기존 설정을 불러와서 Public Key만 갱신
                 */
                function savePublicKeyOnly() {
                    const _doc = window.document;
                    const publicKeyInput = _doc.querySelector('#public_key_input');
                    const publicKey = publicKeyInput ? publicKeyInput.value.trim() : '';
                    
                    // Public Key 입력 여부 확인
                    if (!publicKey) {
                        if (!confirm('Public Key가 비어있습니다.\n\nPublic Key를 삭제하시겠습니까?')) {
                            return;
                        }
                    } else {
                        // Public Key 변경 여부 확인
                        if (!confirm('Public Key를 저장하시겠습니까?\n\n기존 Public Key가 있다면 새 값으로 갱신됩니다.')) {
                            return;
                        }
                    }
                    
                    // 기존 설정 불러오기
                    var getConfigXhr = new XMLHttpRequest();
                    getConfigXhr.onreadystatechange = function() {
                        if (checkAjaxSuc(getConfigXhr)) {
                            try {
                                var configJson = JSON.parse(getConfigXhr.responseText);
                                var exportConfig = configJson.exportConfig || {};
                                
                                // 기존 설정값 가져오기
                                const savePath = _doc.querySelector('#file_save_path')?.value || 
                                                (exportConfig.save_path || '');
                                const saveFormat = _doc.querySelector('#file_save_format')?.value || 
                                                  (exportConfig.save_format || 'json');
                                const autoSaveEnabledElem = _doc.querySelector('#auto_save_on_collect');
                                const autoSaveEnabled = (autoSaveEnabledElem != null) 
                                    ? autoSaveEnabledElem.checked 
                                    : (exportConfig.auto_save_enabled == 1);
                                
                                const saveToFtpCheckbox = _doc.querySelector('#save_to_ftp');
                                const saveToJinieboxConfigValue = 
                                    (exportConfig.save_to_jiniebox !== undefined) ? exportConfig.save_to_jiniebox
                                    : exportConfig.save_to_ftp;
                                const saveToFTP = (saveToFtpCheckbox != null) 
                                    ? saveToFtpCheckbox.checked 
                                    : (parseInt(saveToJinieboxConfigValue, 10) === 1);
                                const ftpEncryptCheckbox = _doc.querySelector('#ftp_encrypt_enabled');
                                const ftpEncryptConfigValue = exportConfig.ftp_encrypt_enabled;
                                const ftpEncryptEnabled = (ftpEncryptCheckbox != null)
                                    ? ftpEncryptCheckbox.checked
                                    : (ftpEncryptConfigValue != null ? parseInt(ftpEncryptConfigValue, 10) === 1 : true);
                                const ftpAddress = _doc.querySelector('#ftp_address')?.value || 
                                                  (exportConfig.ftp_address || '');
                                const ftpId = _doc.querySelector('#ftp_id')?.value || 
                                            (exportConfig.ftp_id || '');
                                
                                // FTP 비밀번호는 기존 값 유지 (null로 전송)
                                const ftpPass = null;
                                
                                // Public Key는 새로 입력한 값 사용
                                
                                // 서버에 저장 요청
                                var saveXhr = new XMLHttpRequest();
                                saveXhr.onreadystatechange = function() {
                                    if (checkAjaxSuc(saveXhr)) {
                                        try {
                                            var resJson = JSON.parse(saveXhr.responseText);
                                            if (resJson.success) {
                                                console.log('Public Key 저장 완료');
                                                
                                                // Public Key 저장 완료 알림
                                                if (publicKey) {
                                                    if (ftpEncryptEnabled) {
                                                        alert('✓ Public Key가 저장되었습니다.\n\n' +
                                                              '파일 암호화가 활성화되었습니다.\n' +
                                                              'FTP Server에서 Private Key를 이용하여 복호화할 수 있습니다.');
                                                    } else {
                                                        alert('✓ Public Key가 저장되었습니다.\n\n' +
                                                              '현재는 암호화 없이 평문으로 업로드하도록 설정되어 있습니다.');
                                                    }
                                                } else {
                                                    alert('✓ Public Key가 삭제되었습니다.\n\n파일 암호화가 비활성화되었습니다.');
                                                }
                                            } else {
                                                // 서버 검증 오류 메시지 표시
                                                if (resJson.message) {
                                                    alert('❌ 저장 실패\n\n' + resJson.message);
                                                } else {
                                                    alert('❌ Public Key 저장 중 오류가 발생했습니다.');
                                                }
                                            }
                                        } catch (e) {
                                            console.error('Public Key 저장 응답 파싱 오류:', e);
                                            alert('❌ 서버 응답 처리 중 오류가 발생했습니다.');
                                        }
                                    }
                                };
                                
                                saveXhr.open('POST', '/export/config', true);
                                saveXhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                                saveXhr.send(JSON.stringify({ 
                                    savePath: savePath, 
                                    format: saveFormat,
                                    autoSaveEnabled: autoSaveEnabled,
                                    saveToJiniebox: saveToFTP,
                                    saveToFTP: saveToFTP,
                                    ftpEncryptEnabled: ftpEncryptEnabled,
                                    ftpAddress: ftpAddress,
                                    ftpId: ftpId,
                                    ftpPass: ftpPass,  // null (기존 값 유지)
                                    publicKey: publicKey
                                }));
                            } catch (e) {
                                console.error('설정 조회 응답 파싱 오류:', e);
                                alert('❌ 기존 설정을 불러오는 중 오류가 발생했습니다.');
                            }
                        }
                    };
                    
                    getConfigXhr.open('GET', '/malls/getinfo', true);
                    getConfigXhr.send();
                }
                
                /**
                 * Public Key 저장 (전용 함수)
                 * 필수: Public Key만 필수
                 */
                function savePublicKeyToServer() {
                    // 필수 필드 검증: Public Key만 필수
                    const validation = validateRequiredFields(['publicKey']);
                    
                    if (!validation.valid) {
                        alert('다음 정보를 입력해야 합니다:\n\n' + validation.missingFields.join(', '));
                        return;
                    }
                    
                    const values = validation.values;
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    console.log('Public Key 저장 완료');
                                    
                                    // Public Key 저장 완료 알림
                                    if (values.publicKey && values.publicKey.trim() !== '') {
                                        if (values.ftpEncryptEnabled && values.saveToFTP) {
                                            alert('✓ Public Key가 저장되었습니다.\n\n' +
                                                  '파일 암호화가 활성화되었습니다.\n' +
                                                  'FTP Server에서 Private Key를 이용하여 복호화할 수 있습니다.');
                                        } else if (values.ftpEncryptEnabled) {
                                            alert('✓ Public Key가 저장되었습니다.\n\n' +
                                                  'FTP 업로드가 활성화되면 암호화되어 전송됩니다.');
                                        } else {
                                            alert('✓ Public Key가 저장되었습니다.\n\n' +
                                                  '현재는 암호화 없이 평문으로 업로드하도록 설정되어 있습니다.');
                                        }
                                    } else {
                                        alert('✓ Public Key가 삭제되었습니다.\n\n파일 암호화가 비활성화되었습니다.');
                                    }
                                } else {
                                    // 서버 검증 오류 메시지 표시
                                    if (resJson.message) {
                                        alert(resJson.message);
                                    }
                                }
                            } catch (e) {
                                console.error('Public Key 저장 응답 파싱 오류:', e);
                            }
                        }
                    };
                    
                    xhr.open('POST', '/export/config', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: values.savePath, 
                        format: values.saveFormat,
                        autoSaveEnabled: values.autoSaveEnabled,
                        saveToJiniebox: values.saveToFTP,
                        saveToFTP: values.saveToFTP,
                        ftpEncryptEnabled: values.ftpEncryptEnabled,
                        ftpAddress: values.ftpAddress,
                        ftpId: values.ftpId,
                        ftpPass: values.ftpPass,
                        publicKey: values.publicKey
                    }));
                }
                
                /**
                 * FTP 정보 및 Public Key 서버에 저장
                 * 필수: FTP 주소, FTP 아이디, Public Key
                 * - FTP 비밀번호: 선택 (입력하지 않으면 기존 비밀번호 유지)
                 * - FTP 주소 + ID + Public Key 입력 (비밀번호 없음): 기존 비밀번호 유지
                 * - FTP 주소 + ID + Public Key + 비밀번호 입력: 모두 갱신
                 */
                function saveFtpInfoToServer() {
                    const _doc = window.document;
                    const ftpAddress = _doc.querySelector('#ftp_address').value || '';
                    const ftpId = _doc.querySelector('#ftp_id').value || '';
                    const ftpPass = _doc.querySelector('#ftp_pass').value || '';
                    const publicKey = _doc.querySelector('#public_key_input').value || '';
                    const ftpEncryptEnabled = _doc.querySelector('#ftp_encrypt_enabled')?.checked !== false;
                    
                    // FTP 주소 필수 체크
                    if (!ftpAddress.trim()) {
                        alert('FTP 주소를 입력해주세요.');
                        return;
                    }
                    
                    // FTP ID 필수 체크
                    if (!ftpId.trim()) {
                        alert('FTP 아이디를 입력해주세요.');
                        return;
                    }
                    
                    // Public Key 필수 체크 (암호화 사용 시)
                    if (ftpEncryptEnabled && !publicKey.trim()) {
                        alert('Public Key를 입력해주세요.\n\nFTP Server에서 생성된 Public Key를 입력하면\nFTP로 전송되는 파일이 암호화됩니다.');
                        return;
                    }
                    
                    // 비밀번호 변경 여부 확인
                    const ftpPassToSend = ftpPass.trim() ? ftpPass : null;
                    const passwordChanged = (ftpPassToSend !== null);
                    
                    console.log('FTP 저장 요청:', {
                        address: ftpAddress,
                        id: ftpId,
                        passwordChanged: passwordChanged
                    });
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    console.log('FTP 정보 및 Public Key 저장 완료');
                                    
                                    let alertMsg = '✅ FTP 정보가 저장되었습니다.\n\n' +
                                                   'FTP 주소: ' + ftpAddress + '\n' +
                                                   'FTP 아이디: ' + ftpId;
                                    
                                    if (ftpEncryptEnabled && publicKey.trim()) {
                                        alertMsg += '\n🔑 Public Key: 저장됨 (파일 암호화 활성화)';
                                    } else if (ftpEncryptEnabled) {
                                        alertMsg += '\n🔑 Public Key: 미설정 (암호화 사용 시 설정해주세요)';
                                    } else {
                                        alertMsg += '\n🌐 FTP 암호화: 비활성화 (평문 업로드)';
                                    }
                                    
                                    if (passwordChanged) {
                                        alertMsg += '\n\n🔒 비밀번호가 암호화되어 저장되었습니다.';
                                        // 비밀번호가 저장되었음을 플래그로 표시
                                        hasFtpPassword = true;
                                        // 입력 필드 초기화 및 placeholder 변경
                                        _doc.querySelector('#ftp_pass').value = '';
                                        _doc.querySelector('#ftp_pass').placeholder = '기존 비밀번호 유지 (변경하려면 입력)';
                                    } else {
                                        alertMsg += '\n\n✓ 비밀번호는 기존 값이 유지됩니다.';
                                    }
                                    
                                    alert(alertMsg);
                                } else {
                                    if (resJson.message) {
                                        alert('❌ 저장 실패\n\n' + resJson.message);
                                    } else {
                                        alert('❌ FTP 정보 및 Public Key 저장 중 오류가 발생했습니다.');
                                    }
                                }
                            } catch (e) {
                                console.error('FTP 정보 및 Public Key 저장 응답 파싱 오류:', e);
                                alert('❌ 서버 응답 처리 중 오류가 발생했습니다.');
                            }
                        }
                    };
                    
                    // 기존 설정값 유지하면서 FTP 정보와 Public Key 함께 업데이트
                    const savePath = _doc.querySelector('#file_save_path').value;
                    const saveFormat = _doc.querySelector('#file_save_format').value;
                    const autoSaveEnabled = _doc.querySelector('#auto_save_on_collect').checked;
                    const saveToFTP = _doc.querySelector('#save_to_ftp').checked;
                    const ftpEncryptEnabledForSave = _doc.querySelector('#ftp_encrypt_enabled')?.checked !== false;
                    
                    xhr.open('POST', '/export/config', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: savePath, 
                        format: saveFormat,
                        autoSaveEnabled: autoSaveEnabled,
                        saveToJiniebox: saveToFTP,
                        saveToFTP: saveToFTP,
                        ftpEncryptEnabled: ftpEncryptEnabledForSave,
                        ftpAddress: ftpAddress,
                        ftpId: ftpId,
                        ftpPass: ftpPassToSend,  // 비어있으면 null (기존 값 유지)
                        publicKey: publicKey
                    }));
                }
                
                /**
                 * 파일 저장 설정을 서버에 저장
                 */
                function saveExportConfigToServer() {
                    const _doc = window.document;
                    const savePath = _doc.querySelector('#file_save_path').value;
                    const saveFormat = _doc.querySelector('#file_save_format').value;
                    const autoSaveEnabled = _doc.querySelector('#auto_save_on_collect').checked;
                    const saveToFTP = _doc.querySelector('#save_to_ftp').checked;
                    const ftpEncryptEnabled = _doc.querySelector('#ftp_encrypt_enabled')?.checked !== false;
                    const ftpAddress = _doc.querySelector('#ftp_address').value || '';
                    const ftpId = _doc.querySelector('#ftp_id').value || '';
                    const ftpPass = _doc.querySelector('#ftp_pass').value || '';
                    const publicKey = _doc.querySelector('#public_key_input').value || '';
                    
                    // 비밀번호가 입력되지 않았으면 null (기존 값 유지)
                    const ftpPassToSend = ftpPass.trim() ? ftpPass : null;
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    console.log('파일 저장 설정 저장 완료');
                                    // 비밀번호가 새로 입력되었으면 플래그 업데이트
                                    if (ftpPassToSend !== null) {
                                        hasFtpPassword = true;
                                        _doc.querySelector('#ftp_pass').value = '';
                                        _doc.querySelector('#ftp_pass').placeholder = '기존 비밀번호 유지 (변경하려면 입력)';
                                    }
                                } else {
                                    // 서버 검증 오류 메시지 표시
                                    if (resJson.message) {
                                        alert(resJson.message);
                                    }
                                }
                            } catch (e) {
                                console.error('설정 저장 응답 파싱 오류:', e);
                            }
                        }
                    };
                    
                    xhr.open('POST', '/export/config', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: savePath, 
                        format: saveFormat,
                        autoSaveEnabled: autoSaveEnabled,
                        saveToJiniebox: saveToFTP,
                        saveToFTP: saveToFTP,
                        ftpEncryptEnabled: ftpEncryptEnabled,
                        ftpAddress: ftpAddress,
                        ftpId: ftpId,
                        ftpPass: ftpPassToSend,  // 비어있으면 null (기존 값 유지)
                        publicKey: publicKey
                    }));
                }
                
                /**
                 * FTP 설정 블록 표시/숨김
                 * @param {boolean} skipSave - true면 저장하지 않음 (초기화 시)
                 */
                function toggleFtpSettings(skipSave) {
                    const saveToFtpCheckbox = document.querySelector('#save_to_ftp');
                    const ftpSettingsDiv = document.querySelector('#jangbogo_ftp_settings');
                    const publicKeyRow = document.querySelector('#public_key_row');
                    const encryptCheckbox = document.querySelector('#ftp_encrypt_enabled');
                    const encryptionEnabled = encryptCheckbox ? encryptCheckbox.checked : true;
                    
                    if (saveToFtpCheckbox.checked) {
                        if (ftpSettingsDiv) {
                            ftpSettingsDiv.style.display = 'block';
                        }
                    } else if (ftpSettingsDiv) {
                        ftpSettingsDiv.style.display = 'none';
                    }
                    
                    if (publicKeyRow) {
                        if (saveToFtpCheckbox.checked && encryptionEnabled) {
                            publicKeyRow.style.display = 'block';
                        } else {
                            publicKeyRow.style.display = 'none';
                        }
                    }
                    
                    // 암호화 안내 및 표시 갱신
                    toggleFtpEncryption(true);
                    
                    if (!skipSave) {
                        saveExportConfigToServer();
                    }
                }
                
                /**
                 * FTP 암호화 옵션 토글
                 * @param {boolean} skipSave - true면 설정 저장을 생략
                 */
                function toggleFtpEncryption(skipSave) {
                    const saveToFtp = document.querySelector('#save_to_ftp')?.checked || false;
                    const encryptCheckbox = document.querySelector('#ftp_encrypt_enabled');
                    const publicKeyRow = document.querySelector('#public_key_row');
                    const helper = document.querySelector('#ftp_encrypt_helper');
                    
                    const encryptionEnabled = encryptCheckbox ? encryptCheckbox.checked : true;
                    
                    if (publicKeyRow) {
                        if (saveToFtp && encryptionEnabled) {
                            publicKeyRow.style.display = 'block';
                        } else {
                            publicKeyRow.style.display = 'none';
                        }
                    }
                    
                    if (helper) {
                        if (encryptionEnabled) {
                            helper.innerHTML = "<i class='bi bi-info-circle'></i> Public Key가 설정되면 FTP로 업로드하기 전에 파일을 암호화합니다.";
                        } else {
                            helper.innerHTML = "<i class='bi bi-info-circle'></i> 암호화를 사용하지 않고 평문 JSON 파일을 업로드합니다.";
                        }
                    }
                    
                    if (!skipSave) {
                        saveExportConfigToServer();
                    }
                }
                
                /**
                 * Public Key 지우기
                 */
                function clearPublicKey(e) {
                    if (confirm('Public Key를 지우시겠습니까?')) {
                        document.querySelector('#public_key_input').value = '';
                        savePublicKeyToServer();
                    }
                }
                
                /**
                 * 파일 저장 및 FTP 업로드
                 * 필수: 저장 위치, 저장 포맷, 저장 범위
                 * 조건부 필수: saveToFTP가 체크되면 FTP 관련 필드들도 필수
                 */
                function exportAndUploadToFtp() {
                    // 필수 필드 검증: savePath, saveFormat, exportLimit
                    // + saveToFTP가 체크되면 FTP 필드들도 필수
                    const validation = validateRequiredFields(
                        ['savePath', 'saveFormat', 'exportLimit'],
                        { 
                            checksaveToFTP: true,      // saveToFTP 체크 시 FTP 필드 필수
                            ignoreFtpPassIfExists: true     // 기존 비밀번호가 있으면 입력 안 해도 됨
                        }
                    );
                    
                    if (!validation.valid) {
                        alert('다음 정보를 모두 입력해야 합니다:\n\n' + validation.missingFields.join(', '));
                        return;
                    }
                    
                    const values = validation.values;
                    
                    // 확인 메시지 (FTP 업로드 여부 표시)
                    const limitMsg = values.exportLimit > 0 ? '최근 ' + values.exportLimit + '개' : '전체';
                    let confirmMsg = '구매 내역을 파일로 저장하시겠습니까?\n\n' +
                                     '저장 경로: ' + values.savePath + '\n' +
                                     '저장 범위: ' + limitMsg + '\n' +
                                     '포맷: ' + values.saveFormat.toUpperCase();
                    
                    if (values.saveToFTP) {
                        confirmMsg += '\n\n🌐 FTP 업로드: 활성화';
                        confirmMsg += values.ftpEncryptEnabled
                            ? '\n🔒 FTP 암호화: 활성화'
                            : '\n⚠️ FTP 암호화: 비활성화 (평문 업로드)';
                    } else {
                        confirmMsg += '\n\n📁 FTP 업로드: 비활성화 (로컬 저장만)';
                    }
                    
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                    
                    console.log('파일 저장 요청:', { 
                        savePath: values.savePath, 
                        saveFormat: values.saveFormat, 
                        limit: values.exportLimit,
                        saveToFTP: values.saveToFTP,
                        ftpEncryptEnabled: values.ftpEncryptEnabled
                    });
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    let msg = '✅ 파일 저장이 완료되었습니다.\n\n' +
                                              '파일: ' + resJson.filePath;
                                    
                                    if (resJson.ftpUploaded) {
                                        msg += '\n\n🌐 FTP 업로드 완료';
                                        if (resJson.encrypted) {
                                            msg += ' (암호화됨 🔒)';
                                        }
                                    } else if (values.saveToFTP === false) {
                                        msg += '\n\n📁 로컬 저장만 완료 (FTP 업로드 비활성화)';
                                    }
                                    
                                    alert(msg);
                                    
                                    console.log('파일 저장 완료:', resJson);
                                } else {
                                    alert('❌ 저장 실패\n\n' + (resJson.message || '알 수 없는 오류'));
                                }
                            } catch (e) {
                                console.error('응답 파싱 오류:', e);
                                alert('❌ 응답 처리 오류');
                            }
                        }
                    };
                    
                    xhr.open('POST', '/export/orders', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: values.savePath,
                        format: values.saveFormat,
                        limit: values.exportLimit,
                        saveToJiniebox: values.saveToFTP,
                        saveToFTP: values.saveToFTP,
                        ftpEncryptEnabled: values.ftpEncryptEnabled
                    }));
                }
                
                /**
                 * 기본 경로(설치 경로의 exports)로 설정
                 */
                function setDefaultDocumentsPath() {
                    const pathInput = document.querySelector('#file_save_path');
                    // Thymeleaf에서 전달받은 기본 경로 사용 (설치 경로\exports)
                    const defaultPath = /*[[${defaultSavePath}]]*/ './exports';
                    
                    if (defaultPath) {
                        pathInput.value = defaultPath;
                        saveExportConfigToServer(); // 변경 시 저장
                        console.log('기본 경로로 설정됨:', defaultPath);
                    } else {
                        // Fallback: 서버에서 경로를 가져올 수 없으면 상대 경로 사용
                        pathInput.value = './exports';
                        saveExportConfigToServer();
                        console.log('기본 경로로 설정됨 (상대경로):', './exports');
                    }
                }
                
                /**
                 * 수집 결과를 파일로 지금 저장
                 */
                function saveCollectionResultsNow() {
                    const _doc = window.document;
                    const savePath = _doc.querySelector('#file_save_path').value;
                    const saveFormat = _doc.querySelector('#file_save_format').value;
                    
                    if (!savePath || savePath.trim() === '') {
                        alert('저장 위치를 입력해주세요.');
                        return;
                    }
                    
                    if (!confirm('구매정보를 파일로 저장하시겠습니까?\n\n저장 위치: ' + savePath + '\n저장 포맷: ' + saveFormat.toUpperCase())) {
                        return;
                    }
                    
                    // 서버에 파일 저장 요청
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    var message = '파일 저장이 완료되었습니다.\n\n저장 위치: ' + (resJson.filePath || savePath);
                                    
                                    // FTP 업로드 결과 표시
                                    if (resJson.ftpUploaded === true) {
                                        message += '\n\n✓ FTP 서버에도 업로드되었습니다.';
                                        if (resJson.encrypted === true) {
                                            message += '\n🔒 파일이 암호화되어 전송되었습니다.';
                                        }
                                    } else if (resJson.ftpUploaded === false) {
                                        message += '\n\n⚠ FTP 업로드 실패 (파일은 로컬에 저장됨)';
                                    }
                                    
                                    alert(message);
                                } else {
                                    alert('파일 저장 실패: ' + (resJson.message || '알 수 없는 오류'));
                                }
                            } catch (e) {
                                alert('파일 저장 응답 처리 중 오류가 발생했습니다.');
                                console.error('응답 파싱 오류:', e);
                            }
                        }
                    };
                    
                    xhr.open('POST', '/export/orders', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: savePath, 
                        format: saveFormat 
                    }));
                }
                </script>
            </div>

            <hr class="mb-3" style="border-top: 1px dotted gray;">

            <div id="autosave_options_div" class="card-body">
                <h5 class="card-title mb-3">구매정보 저장 옵션</h5>
                <div class="mb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="bi bi-file-earmark-text"></i>&nbsp; <span>수집 결과 파일 저장</span>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="saveCollectionResultsNow()">지금저장</button>
                    </div>
                    <div class="ps-3 mb-2">
                        <ul class="list-group">
                            <li class="list-group-item">
                                <div class="d-flex align-items-center gap-2">
                                    <div style="white-space: nowrap;">저장 위치</div>
                                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                                        <input type="text" class="form-control form-control-sm flex-grow-1" 
                                               id="file_save_path" th:value="${defaultSavePath ?: './exports'}" 
                                               placeholder="저장 경로를 입력하세요">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="setDefaultDocumentsPath()" title="기본 경로로 초기화 (설치 폴더\exports)">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>저장 포맷</div>
                                    <div>
                                        <select class="form-select form-select-sm" id="file_save_format" style="width: 150px;">
                                            <option value="json">JSON</option>
                                            <option value="csv">CSV</option>
                                            <option value="excel">Excel</option>
                                        </select>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>저장 범위</div>
                                    <div>
                                        <select class="form-select form-select-sm" id="export_limit" style="width: 150px;">
                                            <option value="100">최근 100개</option>
                                            <option value="0">전체</option>
                                        </select>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div>구매내역 수집시 옵션</div>
                                </div>
                                <div class="ps-3">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div>로컬 파일로 함께 저장</div>
                                        <div>
                                            <input type="checkbox" class="form-check-input" id="auto_save_on_collect" value="1">
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>FTP 서버에 함께 저장</div>
                                        <div>
                                            <input type="checkbox" class="form-check-input" id="save_to_ftp" value="1" 
                                                   onchange="toggleFtpSettings(false)">
                                        </div>
                                    </div>
                                    <!-- FTP 설정 서브 블록 (체크 시 표시) -->
                                    <div id="jangbogo_ftp_settings" class="ps-4" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #dee2e6;">
                                        <div class="mb-2" id="ftp_address_row">
                                            <label class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">FTP 주소</label>
                                            <input type="text" class="form-control form-control-sm" id="ftp_address" 
                                                   placeholder="예: ftp.jiniebox.com 또는 127.0.0.1:21">
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">FTP 아이디</label>
                                            <input type="text" class="form-control form-control-sm" id="ftp_id" 
                                                   placeholder="FTP 사용자 아이디">
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">FTP 비밀번호</label>
                                            <input type="password" class="form-control form-control-sm" id="ftp_pass" 
                                                   placeholder="FTP 비밀번호">
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" role="switch" id="ftp_encrypt_enabled" checked
                                                   onchange="toggleFtpEncryption(false)">
                                            <label class="form-check-label" for="ftp_encrypt_enabled" style="font-size: 0.875rem; font-weight: 500;">
                                                <i class="bi bi-shield-lock"></i> FTP 업로드 시 파일 암호화 (권장)
                                            </label>
                                            <div class="form-text" id="ftp_encrypt_helper" style="font-size: 0.7rem;">
                                                <i class="bi bi-info-circle"></i> Public Key가 설정되면 FTP로 업로드하기 전에 파일을 암호화합니다.
                                            </div>
                                        </div>
                                        <div class="mb-2" id="public_key_row">
                                            <label class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">
                                                <i class="bi bi-key-fill"></i> Public Key (암호화용)
                                            </label>
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control form-control-sm" 
                                                       id="public_key_input" 
                                                       placeholder="FTP 서버에서 생성된 Public Key를 입력하세요"
                                                       style="font-family: monospace; font-size: 0.75rem;"
                                                       onblur="this.value = this.value.trim()">
                                                <button type="button" 
                                                        class="btn btn-outline-primary" 
                                                        onclick="savePublicKeyOnly()"
                                                        title="Public Key 저장">
                                                    <i class="bi bi-save"></i>
                                                </button>
                                            </div>
                                            <div class="form-text" style="font-size: 0.7rem;">
                                                <i class="bi bi-info-circle"></i> Public Key를 입력하면 FTP로 전송되는 파일이 자동으로 암호화됩니다.
                                            </div>
                                        </div>
                                        <div class="d-grid mb-2">
                                            <button type="button" 
                                                    class="btn btn-primary btn-sm" 
                                                    onclick="saveFtpInfoToServer()">
                                                <i class="bi bi-save-fill"></i> FTP 정보 저장
                                            </button>
                                        </div>
                                        <div class="alert alert-info py-1 px-2 mb-0" style="font-size: 0.75rem;">
                                            <i class="bi bi-info-circle"></i> FTP 정보와 Public Key가 암호화되어 저장됩니다.
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-grid">
                                    <button type="button" 
                                            class="btn btn-primary" 
                                            onclick="exportAndUploadToFtp()">
                                        <i class="bi bi-cloud-upload-fill"></i> 파일 저장 및 FTP 업로드
                                    </button>
                                    <small class="text-muted mt-1" style="font-size: 0.75rem;">
                                        <i class="bi bi-info-circle"></i> 구매 내역을 파일로 저장하고, 설정에 따라 FTP 업로드합니다.
                                    </small>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>
</body>
</html>
