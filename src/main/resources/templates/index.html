<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title layout:title-pattern="$DECORATOR_TITLE - $CONTENT_TITLE">Welcome</title>
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .user-info-box {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .user-name {
            font-weight: 600;
            color: #495057;
        }
        .btn-logout-page {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-logout-page:hover {
            background: #c82333;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="page-header mt-3">
            <h1 class="mb-0 text-primary">ì¥ë³´ê³  ê´€ë¦¬í™”ë©´</h1>
            <div class="user-info-box">
                <span class="user-name">
                    <i class="bi bi-person-circle"></i>
                    <span id="currentUserPage">ì‚¬ìš©ì</span>
                </span>
                <button class="btn btn-logout-page btn-sm" onclick="handleLogoutFromPage()">
                    <i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
        
        <hr class="mb-3" style="border-top: 1px dotted gray;">
        
        <div id="card" class="card">
            <div class="card-body">
                <h5 id="card-title" class="card-title">ì‡¼í•‘ ë°ì´í„° ìˆ˜ì§‘(ìë™í™”)</h5>
                <p class="card-text">
                    ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ì‡¼í•‘ëª°ì—ì„œ êµ¬ë§¤í•œ ìƒí’ˆë“¤ì„ ìë™ìœ¼ë¡œ ìˆ˜ì§‘í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.<br/>
                    ì‡¼í•‘ëª° ê³„ì • ì •ë³´ëŠ” ì•”í˜¸í™”ë˜ì–´ í˜„ì¬ ì‹œìŠ¤í…œì— ì €ì¥ë©ë‹ˆë‹¤.
                </p>
            </div>
            
            <hr class="mb-3" style="border-top: 1px dotted gray;">

            <div id="autosave_options_div" class="card-body">
                <h5 class="card-title mb-3">êµ¬ë§¤ì •ë³´ ì €ì¥ ì˜µì…˜</h5>
                <div class="mb-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="bi bi-file-earmark-text"></i>&nbsp; <span>ìˆ˜ì§‘ ê²°ê³¼ íŒŒì¼ ì €ì¥</span>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="saveCollectionResultsNow()">ì§€ê¸ˆì €ì¥</button>
                    </div>
                    <div class="ps-3 mb-2">
                        <ul class="list-group">
                            <li class="list-group-item">
                                <div class="d-flex align-items-center gap-2">
                                    <div style="white-space: nowrap;">ì €ì¥ ìœ„ì¹˜</div>
                                    <div class="d-flex align-items-center gap-2 flex-grow-1">
                                        <input type="text" class="form-control form-control-sm flex-grow-1" 
                                               id="file_save_path" th:value="${defaultSavePath ?: './exports'}" 
                                               placeholder="ì €ì¥ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="setDefaultDocumentsPath()" title="ê¸°ë³¸ ê²½ë¡œë¡œ ì´ˆê¸°í™” (ì„¤ì¹˜ í´ë”\exports)">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>ì €ì¥ í¬ë§·</div>
                                    <div>
                                        <select class="form-select form-select-sm" id="file_save_format" style="width: 150px;">
                                            <option value="json">JSON</option>
                                            <option value="csv">CSV</option>
                                            <option value="excel">Excel</option>
                                        </select>
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>êµ¬ë§¤ë‚´ì—­ ìˆ˜ì§‘ì‹œ í•¨ê»˜ ì €ì¥</div>
                                    <div>
                                        <input type="checkbox" class="form-check-input" id="auto_save_on_collect" value="1">
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>ì§€ë‹ˆë°•ìŠ¤ì—ë„ í•¨ê»˜ ì €ì¥</div>
                                    <div>
                                        <input type="checkbox" class="form-check-input" id="save_to_jiniebox" value="1" 
                                               onchange="toggleJinieboxFtpSettings(false)">
                                    </div>
                                </div>
                                <!-- ì§€ë‹ˆë°•ìŠ¤ FTP ì„¤ì • ì„œë¸Œ ë¸”ë¡ (ì²´í¬ ì‹œ í‘œì‹œ) -->
                                <div id="jiniebox_ftp_settings" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #dee2e6;">
                                    <div class="mb-2">
                                        <label class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">FTP ì£¼ì†Œ</label>
                                        <input type="text" class="form-control form-control-sm" id="ftp_address" 
                                               placeholder="ì˜ˆ: ftp.jiniebox.com ë˜ëŠ” 127.0.0.1:21" 
                                               onchange="saveExportConfigToServer()">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">FTP ì•„ì´ë””</label>
                                        <input type="text" class="form-control form-control-sm" id="ftp_id" 
                                               placeholder="FTP ì‚¬ìš©ì ì•„ì´ë””" 
                                               onchange="saveExportConfigToServer()">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">FTP ë¹„ë°€ë²ˆí˜¸</label>
                                        <input type="password" class="form-control form-control-sm" id="ftp_pass" 
                                               placeholder="FTP ë¹„ë°€ë²ˆí˜¸" 
                                               onchange="saveExportConfigToServer()">
                                    </div>
                                    <div class="alert alert-info py-1 px-2 mb-0" style="font-size: 0.75rem;">
                                        <i class="bi bi-info-circle"></i> FTP ì •ë³´ëŠ” ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
                                    </div>
                                </div>
                            </li>
                            <li class="list-group-item" id="public_key_row" style="display: none;">
                                <div class="mb-2">
                                    <label class="form-label mb-1" style="font-size: 0.875rem; font-weight: 500;">
                                        <i class="bi bi-key-fill"></i> Public Key (ì•”í˜¸í™”ìš©)
                                    </label>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="text" class="form-control form-control-sm flex-grow-1" 
                                               id="public_key_input" 
                                               placeholder="ì§€ë‹ˆë°•ìŠ¤ì—ì„œ ìƒì„±ëœ Public Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                               onchange="saveExportConfigToServer()"
                                               style="font-family: monospace; font-size: 0.75rem;">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="clearPublicKey(event)" 
                                                title="Public Key ì§€ìš°ê¸°">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                    <div class="alert alert-info py-1 px-2 mb-0 mt-2" style="font-size: 0.75rem;">
                                        <i class="bi bi-info-circle"></i> 
                                        Public Keyë¥¼ ì…ë ¥í•˜ë©´ FTPë¡œ ì „ì†¡ë˜ëŠ” íŒŒì¼ì´ ìë™ìœ¼ë¡œ ì•”í˜¸í™”ë©ë‹ˆë‹¤.
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <hr class="mb-3" style="border-top: 1px dotted gray;">

            <div id="automall_div" class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0">ì‡¼í•‘ëª° ëª©ë¡</h5>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="autoCollectSelected()">ìë™ìˆ˜ì§‘</button>
                </div>
                <div id="mall_list">
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shop"></i>&nbsp; <span>SSG(ì‹ ì„¸ê³„)</span>
                        </div>
                        <div class="ps-3 mb-2">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    URL : <a class="icon-link icon-link-hover" href="https://www.ssg.com" target="_blank">
                                        https://www.ssg.com
                                    </a>
                                </li>
                                <li class="list-group-item">ì‹ ì„¸ê³„, ì´ë§ˆíŠ¸, íŠ¸ë ˆì´ë”ìŠ¤, ë…¸ë¸Œëœë“œ</li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>ìë™ ìˆ˜ì§‘ ì£¼ê¸°(ë¶„)</div>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="number" class="form-control form-control-sm mall-interval" 
                                                   data-seq="1" value="0" min="0" placeholder="ì£¼ê¸°(ë¶„)" 
                                                   style="width: 100px;" title="ìë™ìˆ˜ì§‘ ì£¼ê¸°(ë¶„)">
                                            <input type="checkbox" class="form-check-input mall-check" value="1">
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <button id="btn_signin_ssg" type="button"
                                        class="btn btn-primary btn-sm btn-block"
                                        onclick="javascript:openSigninMallForm(1)">ê³„ì •ì—°ê²°</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shop"></i>&nbsp; <span>OASIS(ì˜¤ì•„ì‹œìŠ¤)</span>
                        </div>
                        <div class="ps-3 mb-2">
                            <ul class="list-group">
                                <li class="list-group-item">
                                    URL : <a class="icon-link icon-link-hover"
                                        href="https://www.oasis.co.kr" target="_blank">
                                        https://www.oasis.co.kr
                                    </a>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>ìë™ ìˆ˜ì§‘ ì£¼ê¸°(ë¶„)</div>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="number" class="form-control form-control-sm mall-interval" 
                                                   data-seq="2" value="0" min="0" placeholder="ì£¼ê¸°(ë¶„)" 
                                                   style="width: 100px;" title="ìë™ìˆ˜ì§‘ ì£¼ê¸°(ë¶„)">
                                            <input type="checkbox" class="form-check-input mall-check" value="2">
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item">
                                    <button id="btn_signin_oasis" type="button"
                                        class="btn btn-primary btn-sm btn-block"
                                        onclick="javascript:openSigninMallForm(2)">ê³„ì •ì—°ê²°</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- ì‡¼í•‘ëª° ë¡œê·¸ì¸ íŒì—… ì‹œì‘ -->
                <div id="ModalSigninMall" class="modal fade" tabindex="-1"
                    role="dialog" aria-labelledby="signinMallModal" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 id="signinMallModal_title" class="modal-title">Modal title</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="input-group mb-2">
                                    <input id="usrid_mall" type="text" class="form-control" placeholder="ì•„ì´ë””" value="">
                                    &nbsp;
                                    <input id="usrpass_mall" type="password" class="form-control" placeholder="ë¹„ë°€ë²ˆí˜¸">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button id="btn_connect_mall" type="button" class="btn btn-primary">ê³„ì •ì—°ê²°</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ì‡¼í•‘ëª° ë¡œê·¸ì¸ íŒì—… ë -->
                
                <script type="text/javascript">
                
                /**
                 * ì‡¼í•‘ëª° ì •ë³´ ì´ˆê¸°í™”
                 */
                document.addEventListener('DOMContentLoaded', function() { //dom ì´ ì¤€ë¹„ë˜ë©´ ì‹¤í–‰
                    const _doc = window.document;
                    var path = "/malls/getinfo";
                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText;
                            if (resMsg.length > 0) {
                                let resJson = JSON.parse(resMsg);
                                var alertMsg = null;
                                if (resJson.code == 200) {
                                    // ê¸°ë³¸ ì €ì¥ ê²½ë¡œ ì„¤ì • (Windows ë‚´ë¬¸ì„œ)
                                    if (resJson.defaultExportPath) {
                                        _doc.defaultExportPath = resJson.defaultExportPath; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                                    }
                                    
                                    // íŒŒì¼ ì €ì¥ ì„¤ì • ì ìš©
                                    if (resJson.exportConfig) {
                                        const exportConfig = resJson.exportConfig;
                                        const pathInput = _doc.querySelector('#file_save_path');
                                        const formatSelect = _doc.querySelector('#file_save_format');
                                        const autoSaveCheck = _doc.querySelector('#auto_save_on_collect');
                                        const saveToJinieboxCheck = _doc.querySelector('#save_to_jiniebox');
                                        const ftpAddressInput = _doc.querySelector('#ftp_address');
                                        const ftpIdInput = _doc.querySelector('#ftp_id');
                                        const ftpPassInput = _doc.querySelector('#ftp_pass');
                                        
                                        if (exportConfig.save_path && exportConfig.save_path !== '') {
                                            pathInput.value = exportConfig.save_path;
                                        } else if (resJson.defaultExportPath) {
                                            pathInput.value = resJson.defaultExportPath;
                                        }
                                        
                                        if (exportConfig.save_format) {
                                            formatSelect.value = exportConfig.save_format;
                                        }
                                        
                                        if (exportConfig.auto_save_enabled != null) {
                                            autoSaveCheck.checked = (exportConfig.auto_save_enabled == 1);
                                        }
                                        
                                        // ì§€ë‹ˆë°•ìŠ¤ ì €ì¥ ì„¤ì • ì ìš©
                                        if (exportConfig.save_to_jiniebox != null) {
                                            saveToJinieboxCheck.checked = (exportConfig.save_to_jiniebox == 1);
                                        }
                                        
                                        // FTP ì •ë³´ ì ìš©
                                        if (exportConfig.ftp_address) {
                                            ftpAddressInput.value = exportConfig.ftp_address;
                                        }
                                        if (exportConfig.ftp_id) {
                                            ftpIdInput.value = exportConfig.ftp_id;
                                        }
                                        if (exportConfig.ftp_pass) {
                                            ftpPassInput.value = exportConfig.ftp_pass;
                                        }
                                        
                                        // Public Key í‘œì‹œ
                                        const publicKeyInput = _doc.querySelector('#public_key_input');
                                        if (exportConfig.public_key && exportConfig.public_key !== '') {
                                            publicKeyInput.value = exportConfig.public_key;
                                        }
                                        
                                        // FTP ì„¤ì • ë¸”ë¡ ì´ˆê¸° í‘œì‹œ/ìˆ¨ê¹€ (ì €ì¥í•˜ì§€ ì•ŠìŒ)
                                        toggleJinieboxFtpSettings(true);
                                    } else if (resJson.defaultExportPath) {
                                        _doc.querySelector('#file_save_path').value = resJson.defaultExportPath;
                                    }
                                        
                                    if (resJson.malls) {
                                        let malls = _doc.malls = resJson.malls;
                                        malls.forEach(mall => {
                                            if (_doc.querySelector("#btn_signin_"+mall.id)) { //ì‚¬ìš© ê°€ëŠ¥ ì‡¼í•‘ëª°
                                                if (mall.account_status == 1) {
                                                    if (mall.usrid) {
                                                        _doc.querySelector("#usrid_mall").value = mall.usrid;
                                                        _doc.querySelector("#usrpass_mall").value = "**********";
                                                    }
                                                    _doc.querySelector("#usrid_mall").disabled = true;;
                                                    _doc.querySelector("#usrpass_mall").disabled = true;                                        
                                                    _doc.querySelector("#btn_signin_"+mall.id).textContent = 'ì—°ê²°í•´ì œ';
                                                    _doc.querySelector("#btn_signin_"+mall.id).className = 'btn btn-outline-success';
                                                    _doc.querySelector("#btn_signin_"+mall.id).setAttribute('onclick', 'javascript:connectMall('+ mall.seq +')');
                                                    hideElement(_doc.querySelector("#mall_account_"+mall.id));
                                                    mall.account_status = 1;
                                                } else {
                                                    _doc.querySelector("#usrid_mall").disabled = false;;
                                                    _doc.querySelector("#usrpass_mall").disabled = false;;
                                                    _doc.querySelector("#btn_signin_"+mall.id).textContent = 'ê³„ì •ì—°ê²°';
                                                    _doc.querySelector("#btn_signin_"+mall.id).className = 'btn btn-primary';
                                                    _doc.querySelector("#btn_signin_"+mall.id).setAttribute('onclick', 'javascript:openSigninMallForm('+ mall.seq +')');
                                                    showElement(_doc.querySelector("#mall_account_"+mall.id));
                                                    mall.account_status = 0;
                                                }
                                                // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë°˜ì˜ (auto_collect)
                                                const cb = _doc.querySelector('input.mall-check[value="'+ mall.seq +'"]');
                                                if (cb) { cb.checked = (mall.auto_collect == 1); }
                                                
                                                // ì£¼ê¸° ì„¤ì • ê°’ ë°˜ì˜ (collect_interval_minutes)
                                                const intervalInput = _doc.querySelector('input.mall-interval[data-seq="'+ mall.seq +'"]');
                                                if (intervalInput && mall.collect_interval_minutes != null) {
                                                    intervalInput.value = mall.collect_interval_minutes;
                                                }
                                            }
                                        });
                                    }
                                    if (resJson.boxes) {
                                        _doc.boxes = resJson.boxes;
                                    }
                                    if (resJson.rules) {
                                        const div_rules = _doc.querySelector("#rules");

                                        let rules = _doc.rules = resJson.rules;
                                        Object.keys(rules).forEach(key => {
                                            const rule = rules[key];
                                            createRuleCard(div_rules, rule);
                                        });
                                    }
                                }
                            }
                        }
                    };
                    sendGet(_ajax, path);
                });

                // ë°°ì—´ì—ì„œ seqë¡œ mall ê°ì²´ ì°¾ê¸°
                function findMallBySeq(seqm) {
                    const malls = (window.document.malls || []);
                    return malls.find(m => String(m.seq) === String(seqm));
                }

                /**
                 * ì‡¼í•‘ëª° ì—°ê²° íŒì—…
                 */
                function openSigninMallForm(seqm) {
                    const _doc = window.document;
                    const mall = findMallBySeq(seqm);

                    if (mall && (mall.account_status === 1 || mall.status === 1)) {
                        connectMall(seqm);
                    } else {
                        let inp_id = _doc.querySelector("#usrid_mall");
                        let inp_pw = _doc.querySelector("#usrpass_mall");
                        
                        //ì´ˆê¸°í™”
                        inp_id.value = "";
                        inp_pw.value = "";
                        inp_id.disabled = false;
                        inp_pw.disabled = false;

                        if (seqm == 1) {
                            _doc.querySelector('#signinMallModal_title').innerText = "SSG ê³„ì •ì—°ê²°";
                        } else if (seqm == 2) {
                            _doc.querySelector('#signinMallModal_title').innerText = "ì˜¤ì•„ì‹œìŠ¤ ê³„ì •ì—°ê²°";
                        }
                        _doc.querySelector('#btn_connect_mall').setAttribute('onclick', 'javascript:connectMall('+ seqm +')');
                        var myModal = bootstrap.Modal.getOrCreateInstance(_doc.querySelector('#ModalSigninMall'));
                        myModal.show();
                    }
                }

                /**
                 * ì‡¼í•‘ëª°ì— ì—°ê²° ì‹œë„
                 */
                function connectMall(seqm) {
                    const _doc = window.document;
                    const mall = findMallBySeq(seqm);

                    var statusTo = -1;
                    if (mall && (mall.account_status === 1 || mall.status === 1)) {
                        if (!confirm("ì—°ê²°ì„ í•´ì œí• ê¹Œìš”?")) {
                            return -1;
                        }
                        statusTo = 0;
                    } else {
                        statusTo = 1;
                    }

                    let inp_id = _doc.querySelector("#usrid_mall");
                    let inp_pw = _doc.querySelector("#usrpass_mall");
                    let frm_conn = mall ? _doc.querySelector("#mall_account_"+ mall.id) : null;
                    let btn_conn = _doc.querySelector("#btn_connect_mall");
                    let btn_signin = mall ? _doc.querySelector("#btn_signin_"+ mall.id) : null;
                    
                    attachSpinnerButton(btn_conn);

                    var path = "/mall/connect";
                    var params = "seq="+seqm;
                    params += "&usrid="+inp_id.value;
                    params += "&usrpass="+inp_pw.value;
                    params += "&statusTo="+statusTo; //ìš”ì²­í•˜ë ¤ëŠ” ì—°ê²° ìƒíƒœ
                    
                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText;
                            if (resMsg.length > 0) {
                                var resJson = JSON.parse(resMsg);
                                var alertMsg = null;
                                var btn_txt = "ê³„ì •ì—°ê²°";
                                var btn_class = "btn btn-primary";
                                if (resJson.code == "000") {
                                    var status = resJson.status;
                                    if (mall) { mall.account_status = status; mall.status = status; }
                                    if (status == 1) {
                                        inp_id.disabled = true;
                                        inp_pw.disabled = true;
                                        btn_txt = 'ì—°ê²°í•´ì œ';
                                        btn_class = 'btn btn-outline-success';
                                        hideElement(frm_conn);
                                        if (btn_signin) { btn_signin.setAttribute('onclick', 'javascript:connectMall('+ seqm +')'); }
                                    } else {
                                        inp_id.disabled = false;
                                        inp_pw.disabled = false;
                                        btn_txt = 'ê³„ì •ì—°ê²°';
                                        showElement(frm_conn);
                                        if (btn_signin) { btn_signin.setAttribute('onclick', 'javascript:openSigninMallForm('+ seqm +')'); }
                                    }                                                            
                                }
                                
                                if (resJson.msg) {
                                    alert(resJson.msg);
                                }

                                removeSpinnerButton(btn_conn, "ê³„ì •ì—°ê²°");
                                if (btn_signin) { btn_signin.innerText = btn_txt; btn_signin.className = btn_class; }

                                var myModal = bootstrap.Modal.getOrCreateInstance(_doc.querySelector('#ModalSigninMall'));
                                myModal.hide();
                            }
                        }
                    };
                    sendPost(_ajax, path, params);
                }

                // ì„ íƒëœ ì‡¼í•‘ëª° ìë™ìˆ˜ì§‘ ì¦‰ì‹œ ì‹¤í–‰ ë˜ëŠ” ì·¨ì†Œ
                function autoCollectSelected() {
                    const _doc = window.document;
                    const checked = Array.from(_doc.querySelectorAll('input.mall-check:checked'))
                        .map(el => String(el.value));
                    if (!checked.length) {
                        alert('ì„ íƒëœ ì‡¼í•‘ëª°ì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ì¦‰ì‹œ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
                    const executeNow = confirm('ì§€ê¸ˆ ì¦‰ì‹œ ìµœê·¼ êµ¬ë§¤ëª©ë¡ì„ ìˆ˜ì§‘í• ê¹Œìš”?\n\ní™•ì¸: ì¦‰ì‹œ ìˆ˜ì§‘ ì‹œì‘\nì·¨ì†Œ: ì£¼ê¸°ì  ìˆ˜ì§‘ë§Œ í™œì„±í™”');

                    var _ajax = new XMLHttpRequest();
                    _ajax.onreadystatechange = function () {
                        if (checkAjaxSuc(_ajax)) {
                            var resMsg = _ajax.responseText || '';
                            try {
                                var resJson = JSON.parse(resMsg);
                                if (resJson) {
                                    // ì˜¤ë¥˜ ì²˜ë¦¬
                                    var errs = [];
                                    if (Array.isArray(resJson.decryptionFailed) && resJson.decryptionFailed.length) {
                                        errs = errs.concat(resJson.decryptionFailed.map(String));
                                    }
                                    if (Array.isArray(resJson.skipped) && resJson.skipped.length) {
                                        errs = errs.concat(resJson.skipped.map(String));
                                    }

                                    if (errs.length) {
                                        // ì˜¤ë¥˜ë‚œ ì‡¼í•‘ëª°ë“¤ì„ UIì—ì„œ í•´ì œ ìƒíƒœë¡œ ì „í™˜
                                        errs.forEach(function(seq){
                                            try {
                                                var mall = findMallBySeq(seq);
                                                if (!mall) return;
                                                mall.account_status = 0; mall.status = 0;
                                                var btn = document.querySelector('#btn_signin_' + mall.id);
                                                if (btn) {
                                                    btn.innerText = 'ê³„ì •ì—°ê²°';
                                                    btn.className = 'btn btn-primary btn-sm btn-block';
                                                    btn.setAttribute('onclick', 'javascript:openSigninMallForm(' + seq + ')');
                                                }
                                            } catch(e) { /* ignore per item */ }
                                        });
                                    }
                                    
                                    // ë©”ì‹œì§€ í‘œì‹œ (ìë™ìˆ˜ì§‘ ì™„ë£Œ ë©”ì‹œì§€ë§Œ)
                                    let msg = resJson.message || '';
                                    if (msg) {
                                        alert(msg);
                                    }
                                    
                                    // íŒŒì¼ ìë™ì €ì¥ ê²°ê³¼ëŠ” ì„œë²„ ë¡œê·¸ë¡œë§Œ ê¸°ë¡ (alert ì•ˆ í•¨)
                                    if (resJson.autoSaved && resJson.exportedFile) {
                                        console.log('íŒŒì¼ ìë™ì €ì¥ ì™„ë£Œ:', resJson.exportedFile);
                                    } else if (resJson.autoSaveSkipped) {
                                        console.log('íŒŒì¼ ì €ì¥ ê±´ë„ˆëœ€:', resJson.autoSaveReason);
                                    } else if (resJson.autoSaveError) {
                                        console.warn('íŒŒì¼ ìë™ì €ì¥ ì‹¤íŒ¨:', resJson.autoSaveError);
                                    }
                                }
                            } catch (e) {
                                // ignore
                            }
                        }
                    };
                    _ajax.open('POST', '/malls/auto-collect', true);
                    _ajax.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    // ì‹¤í–‰ ì „ì— ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥
                    saveAutoCollectFlagsFromUI(function() {
                        _ajax.send(JSON.stringify({ seqs: checked, executeNow: executeNow }));
                    });
                }

                // ì²´í¬ë°•ìŠ¤ ì „ì²´ ìƒíƒœ ë° ì£¼ê¸° ì €ì¥ (ì²´í¬ëœ seqë§Œ ì „ë‹¬, ë‚˜ë¨¸ì§€ëŠ” 0 ì²˜ë¦¬)
                function saveAutoCollectFlagsFromUI(done) {
                    const _doc = window.document;
                    const checked = Array.from(_doc.querySelectorAll('input.mall-check:checked'))
                        .map(el => String(el.value));
                    
                    // ëª¨ë“  ì‡¼í•‘ëª°ì˜ ì£¼ê¸° ê°’ ìˆ˜ì§‘
                    const intervals = {};
                    _doc.querySelectorAll('input.mall-interval').forEach(input => {
                        const seq = input.getAttribute('data-seq');
                        const value = parseInt(input.value) || 0;
                        if (seq) {
                            intervals[seq] = value;
                        }
                    });
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            if (typeof done === 'function') done();
                        }
                    };
                    xhr.open('POST', '/malls/auto-collect/flags', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ seqs: checked, intervals: intervals }));
                }

                // ì²´í¬ë°•ìŠ¤ ë˜ëŠ” ì£¼ê¸° ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì €ì¥
                document.addEventListener('change', function(e) {
                    if (e.target && (e.target.matches('input.mall-check') || e.target.matches('input.mall-interval'))) {
                        saveAutoCollectFlagsFromUI();
                    }
                    
                    // íŒŒì¼ ì €ì¥ ì„¤ì • ë³€ê²½ ì‹œ ì €ì¥
                    if (e.target && (e.target.id === 'auto_save_on_collect' || 
                                     e.target.id === 'file_save_format')) {
                        saveExportConfigToServer();
                    }
                });
                
                // ì €ì¥ ê²½ë¡œ ì…ë ¥ í•„ë“œëŠ” blur ì‹œ ì €ì¥
                document.querySelector('#file_save_path').addEventListener('blur', function() {
                    saveExportConfigToServer();
                });
                
                /**
                 * íŒŒì¼ ì €ì¥ ì„¤ì •ì„ ì„œë²„ì— ì €ì¥
                 */
                function saveExportConfigToServer() {
                    const _doc = window.document;
                    const savePath = _doc.querySelector('#file_save_path').value;
                    const saveFormat = _doc.querySelector('#file_save_format').value;
                    const autoSaveEnabled = _doc.querySelector('#auto_save_on_collect').checked;
                    const saveToJiniebox = _doc.querySelector('#save_to_jiniebox').checked;
                    const ftpAddress = _doc.querySelector('#ftp_address').value || '';
                    const ftpId = _doc.querySelector('#ftp_id').value || '';
                    const ftpPass = _doc.querySelector('#ftp_pass').value || '';
                    const publicKey = _doc.querySelector('#public_key_input').value || '';
                    
                    // ì§€ë‹ˆë°•ìŠ¤ ì €ì¥ì´ ì²´í¬ë˜ì–´ ìˆìœ¼ë©´ FTP ì •ë³´ í•„ìˆ˜ ì…ë ¥ ê²€ì¦
                    if (saveToJiniebox) {
                        const missingFields = [];
                        if (!ftpAddress.trim()) missingFields.push('FTP ì£¼ì†Œ');
                        if (!ftpId.trim()) missingFields.push('FTP ì•„ì´ë””');
                        if (!ftpPass.trim()) missingFields.push('FTP ë¹„ë°€ë²ˆí˜¸');
                        
                        if (missingFields.length > 0) {
                            alert('ì§€ë‹ˆë°•ìŠ¤ ì €ì¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤:\n\n' + missingFields.join(', '));
                            return; // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì €ì¥í•˜ì§€ ì•ŠìŒ
                        }
                    }
                    
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    console.log('íŒŒì¼ ì €ì¥ ì„¤ì • ì €ì¥ ì™„ë£Œ');
                                } else {
                                    // ì„œë²„ ê²€ì¦ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                                    if (resJson.message) {
                                        alert(resJson.message);
                                    }
                                }
                            } catch (e) {
                                console.error('ì„¤ì • ì €ì¥ ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:', e);
                            }
                        }
                    };
                    
                    xhr.open('POST', '/export/config', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: savePath, 
                        format: saveFormat,
                        autoSaveEnabled: autoSaveEnabled,
                        saveToJiniebox: saveToJiniebox,
                        ftpAddress: ftpAddress,
                        ftpId: ftpId,
                        ftpPass: ftpPass,
                        publicKey: publicKey
                    }));
                }
                
                /**
                 * ì§€ë‹ˆë°•ìŠ¤ FTP ì„¤ì • ë¸”ë¡ í‘œì‹œ/ìˆ¨ê¹€
                 * @param {boolean} skipSave - trueë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ (ì´ˆê¸°í™” ì‹œ)
                 */
                function toggleJinieboxFtpSettings(skipSave) {
                    const checkbox = document.querySelector('#save_to_jiniebox');
                    const ftpSettingsDiv = document.querySelector('#jiniebox_ftp_settings');
                    const publicKeyRow = document.querySelector('#public_key_row');
                    
                    if (checkbox.checked) {
                        ftpSettingsDiv.style.display = 'block';
                        publicKeyRow.style.display = 'block';
                    } else {
                        ftpSettingsDiv.style.display = 'none';
                        publicKeyRow.style.display = 'none';
                    }
                    
                    // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì„œë²„ì— ì €ì¥ (ì´ˆê¸°í™” ì‹œì—ëŠ” ì œì™¸)
                    if (!skipSave) {
                        saveExportConfigToServer();
                    }
                }
                
                /**
                 * Public Key ì§€ìš°ê¸°
                 */
                function clearPublicKey(e) {
                    if (confirm('Public Keyë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        document.querySelector('#public_key_input').value = '';
                        saveExportConfigToServer();
                    }
                }
                
                
                /**
                 * ê¸°ë³¸ ê²½ë¡œ(ì„¤ì¹˜ ê²½ë¡œì˜ exports)ë¡œ ì„¤ì •
                 */
                function setDefaultDocumentsPath() {
                    const pathInput = document.querySelector('#file_save_path');
                    // Thymeleafì—ì„œ ì „ë‹¬ë°›ì€ ê¸°ë³¸ ê²½ë¡œ ì‚¬ìš© (ì„¤ì¹˜ ê²½ë¡œ\exports)
                    const defaultPath = /*[[${defaultSavePath}]]*/ './exports';
                    
                    if (defaultPath) {
                        pathInput.value = defaultPath;
                        saveExportConfigToServer(); // ë³€ê²½ ì‹œ ì €ì¥
                        console.log('ê¸°ë³¸ ê²½ë¡œë¡œ ì„¤ì •ë¨:', defaultPath);
                    } else {
                        // Fallback: ì„œë²„ì—ì„œ ê²½ë¡œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìœ¼ë©´ ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
                        pathInput.value = './exports';
                        saveExportConfigToServer();
                        console.log('ê¸°ë³¸ ê²½ë¡œë¡œ ì„¤ì •ë¨ (ìƒëŒ€ê²½ë¡œ):', './exports');
                    }
                }
                
                /**
                 * ìˆ˜ì§‘ ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì§€ê¸ˆ ì €ì¥
                 */
                function saveCollectionResultsNow() {
                    const _doc = window.document;
                    const savePath = _doc.querySelector('#file_save_path').value;
                    const saveFormat = _doc.querySelector('#file_save_format').value;
                    
                    if (!savePath || savePath.trim() === '') {
                        alert('ì €ì¥ ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    if (!confirm('êµ¬ë§¤ì •ë³´ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì €ì¥ ìœ„ì¹˜: ' + savePath + '\nì €ì¥ í¬ë§·: ' + saveFormat.toUpperCase())) {
                        return;
                    }
                    
                    // ì„œë²„ì— íŒŒì¼ ì €ì¥ ìš”ì²­
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function() {
                        if (checkAjaxSuc(xhr)) {
                            try {
                                var resJson = JSON.parse(xhr.responseText);
                                if (resJson.success) {
                                    var message = 'íŒŒì¼ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì €ì¥ ìœ„ì¹˜: ' + (resJson.filePath || savePath);
                                    
                                    // FTP ì—…ë¡œë“œ ê²°ê³¼ í‘œì‹œ
                                    if (resJson.ftpUploaded === true) {
                                        message += '\n\nâœ“ FTP ì„œë²„ì—ë„ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.';
                                        if (resJson.encrypted === true) {
                                            message += '\nğŸ”’ íŒŒì¼ì´ ì•”í˜¸í™”ë˜ì–´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                        }
                                    } else if (resJson.ftpUploaded === false) {
                                        message += '\n\nâš  FTP ì—…ë¡œë“œ ì‹¤íŒ¨ (íŒŒì¼ì€ ë¡œì»¬ì— ì €ì¥ë¨)';
                                    }
                                    
                                    alert(message);
                                } else {
                                    alert('íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: ' + (resJson.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                                }
                            } catch (e) {
                                alert('íŒŒì¼ ì €ì¥ ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                console.error('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:', e);
                            }
                        }
                    };
                    
                    xhr.open('POST', '/export/orders', true);
                    xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
                    xhr.send(JSON.stringify({ 
                        savePath: savePath, 
                        format: saveFormat 
                    }));
                }
                </script>
            </div>
            
        </div>
        
    </div>
</body>
</html>
